<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>【置顶】Springboot之---强大的Servlet | 赵KK的个人博客</title>
  <meta name="description" content="If I have seen further, it is by standing on the shoulders of giants如果我比别人看得更远,那是因为我站在巨人的肩膀上如今回头看下Servlet不仅如此强大,还具有很强烈的参考意义,能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet,可能在其中穿插其他的关联知识点,旨在能从此次的学习中获取更多的知识点参考资料">
<meta property="og:type" content="article">
<meta property="og:title" content="【置顶】Springboot之---强大的Servlet">
<meta property="og:url" content="https://zkkget.github.io/posts/20220127clho7byh60014vwuj5v684524.html">
<meta property="og:site_name" content="赵KK个人博客第三站">
<meta property="og:description" content="If I have seen further, it is by standing on the shoulders of giants如果我比别人看得更远,那是因为我站在巨人的肩膀上如今回头看下Servlet不仅如此强大,还具有很强烈的参考意义,能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet,可能在其中穿插其他的关联知识点,旨在能从此次的学习中获取更多的知识点参考资料">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/compliance.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/ApplicationContext.jpg">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/AnnotationConfigWebApplicationContext.jpg">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet%E5%85%B3%E7%B3%BB%E5%9B%BE.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet-service.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/service-post.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.jpg">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/statusCode.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/listener.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/Threadlocal.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/ThreadLocalremove.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/oncePerRequestFilter.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/embedded.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/drivermanager.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/connection.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/drivermanager.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%9E%8B.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/fg15k701aa.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/rediscachewriter.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/connectionfactory.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/jms.jpg">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/AMQP.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/kafka.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/kafka2.png">
<meta property="og:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/snappy.png">
<meta property="article:published_time" content="2022-01-27T01:45:49.000Z">
<meta property="article:modified_time" content="2022-09-15T09:34:42.485Z">
<meta property="article:author" content="赵KK">
<meta property="article:tag" content="Springboot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://zkkget.github.io/posts/20220127clho7byh60014vwuj5v684524.html">
  
    <link rel="alternate" href="/atom.xml" title="赵KK个人博客第三站" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://kkget.github.io/" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">赵kk</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">java Developer &amp; pm</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 北京, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://kkget.github.io/" target="_blank" title="主站博客" data-toggle=tooltip data-placement=top><i class="icon icon-主站博客"></i></a></li>
        
        <li><a href="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.png" target="_blank" title="公众号" data-toggle=tooltip data-placement=top><i class="icon icon-公众号"></i></a></li>
        
        <li><a href="https://cloud.tencent.com/developer/inventory/14725" target="_blank" title="云+社区" data-toggle=tooltip data-placement=top><i class="icon icon-云+社区"></i></a></li>
        
        <li><a href="/1462018576" target="_blank" title="QQ" data-toggle=tooltip data-placement=top><i class="icon icon-QQ"></i></a></li>
        
    </ul>

    </nav>
  </div>
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
  <style>
      .pace .pace-progress {
          background: #1E92FB; /*进度条颜色*/
          height: 3px;
      }
      .pace .pace-progress-inner {
           box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
      }
      .pace .pace-activity {
          border-top-color: #1E92FB;    /*上边框颜色*/
          border-left-color: #1E92FB;    /*左边框颜色*/
      }
  </style>

</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>有问题可搜索</br>个人公众号<赵KK日常技术记录></br>或联系作者进行沟通!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%90%88%E9%9B%86/">AI工具大合集</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud-Nacos/">SpringCloud Nacos</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Springboot/">Springboot</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%AC%E4%BC%97%E5%8F%B7%E3%80%90%E8%B5%B5KK%E6%97%A5%E5%B8%B8%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95%E3%80%91%E6%AC%A2%E8%BF%8E%E5%85%B3%E6%B3%A8/">公众号【赵KK日常技术记录】欢迎关注</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%93%E9%A2%98/">并发编程专题</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E6%97%A5%E6%97%A9%E6%8A%A560s/">每日早报60s</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E7%BB%8F/">面经</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%90%88%E9%9B%86/" rel="tag">AI工具大合集</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CompletableFuture/" rel="tag">CompletableFuture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ContainsAll/" rel="tag">ContainsAll</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/" rel="tag">JSON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JunitTest/" rel="tag">JunitTest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode%E7%AE%97%E6%B3%95%E9%A2%98/" rel="tag">Leetcode算法题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/List%E9%81%8D%E5%8E%86%E5%88%A0%E9%99%A4/" rel="tag">List遍历删除</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud-Nacos/" rel="tag">SpringCloud Nacos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloudAlibaba/" rel="tag">SpringCloudAlibaba</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thymleaf/" rel="tag">Thymleaf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yapi/" rel="tag">Yapi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opencv/" rel="tag">opencv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valine/" rel="tag">valine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E3%80%90%E8%B5%B5KK%E6%97%A5%E5%B8%B8%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95%E3%80%91%E6%AC%A2%E8%BF%8E%E5%85%B3%E6%B3%A8/" rel="tag">公众号【赵KK日常技术记录】欢迎关注</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%A1%E5%9E%92%E6%9C%BA/" rel="tag">堡垒机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%9E%E6%88%98/" rel="tag">实战</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%93%E9%A2%98/" rel="tag">并发编程专题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%8F%E6%97%A5%E6%97%A9%E6%8A%A560s/" rel="tag">每日早报60s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E7%BB%8F/" rel="tag">面经</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95-%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" rel="tag">面试,字节跳动</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AI%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%90%88%E9%9B%86/" style="font-size: 13.5px;">AI工具大合集</a> <a href="/tags/CompletableFuture/" style="font-size: 13px;">CompletableFuture</a> <a href="/tags/ContainsAll/" style="font-size: 13px;">ContainsAll</a> <a href="/tags/JSON/" style="font-size: 13px;">JSON</a> <a href="/tags/JunitTest/" style="font-size: 13px;">JunitTest</a> <a href="/tags/Leetcode%E7%AE%97%E6%B3%95%E9%A2%98/" style="font-size: 13px;">Leetcode算法题</a> <a href="/tags/List%E9%81%8D%E5%8E%86%E5%88%A0%E9%99%A4/" style="font-size: 13px;">List遍历删除</a> <a href="/tags/MQ/" style="font-size: 13px;">MQ</a> <a href="/tags/MySQL/" style="font-size: 13px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 13.5px;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 13px;">Nginx</a> <a href="/tags/SpringCloud-Nacos/" style="font-size: 13px;">SpringCloud Nacos</a> <a href="/tags/SpringCloudAlibaba/" style="font-size: 13px;">SpringCloudAlibaba</a> <a href="/tags/Springboot/" style="font-size: 13.5px;">Springboot</a> <a href="/tags/Thymleaf/" style="font-size: 13px;">Thymleaf</a> <a href="/tags/Yapi/" style="font-size: 13px;">Yapi</a> <a href="/tags/leetcode/" style="font-size: 14px;">leetcode</a> <a href="/tags/opencv/" style="font-size: 13px;">opencv</a> <a href="/tags/valine/" style="font-size: 13px;">valine</a> <a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 13px;">事务</a> <a href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E3%80%90%E8%B5%B5KK%E6%97%A5%E5%B8%B8%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95%E3%80%91%E6%AC%A2%E8%BF%8E%E5%85%B3%E6%B3%A8/" style="font-size: 13px;">公众号【赵KK日常技术记录】欢迎关注</a> <a href="/tags/%E5%A0%A1%E5%9E%92%E6%9C%BA/" style="font-size: 13px;">堡垒机</a> <a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 13px;">实战</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%93%E9%A2%98/" style="font-size: 13px;">并发编程专题</a> <a href="/tags/%E6%AF%8F%E6%97%A5%E6%97%A9%E6%8A%A560s/" style="font-size: 13px;">每日早报60s</a> <a href="/tags/%E9%9D%A2%E7%BB%8F/" style="font-size: 13px;">面经</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 13.5px;">面试</a> <a href="/tags/%E9%9D%A2%E8%AF%95-%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" style="font-size: 13px;">面试,字节跳动</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/AI%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%90%88%E9%9B%86/">AI工具大合集</a>
              </p>
              <p class="item-title">
                <a href="/posts/20230515a1.html" class="title">免费的ChatGpt专栏</a>
              </p>
              <p class="item-date">
                <time datetime="2023-05-15T01:40:04.000Z" itemprop="datePublished">2023-05-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/posts/20230510a1.html" class="title">不限次数的AI对标ChatGPT提高生产力无需魔法</a>
              </p>
              <p class="item-date">
                <time datetime="2023-05-10T02:37:16.000Z" itemprop="datePublished">2023-05-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/posts/20230509a1.html" class="title">Springboot正确的停机方式</a>
              </p>
              <p class="item-date">
                <time datetime="2023-05-09T07:26:02.000Z" itemprop="datePublished">2023-05-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%85%AC%E4%BC%97%E5%8F%B7%E3%80%90%E8%B5%B5KK%E6%97%A5%E5%B8%B8%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95%E3%80%91%E6%AC%A2%E8%BF%8E%E5%85%B3%E6%B3%A8/">公众号【赵KK日常技术记录】欢迎关注</a>
              </p>
              <p class="item-title">
                <a href="/posts/20230427a1.html" class="title">公众号【赵KK日常技术记录】欢迎关注点击</a>
              </p>
              <p class="item-date">
                <time datetime="2023-04-27T09:56:45.000Z" itemprop="datePublished">2023-04-27</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/AI%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%90%88%E9%9B%86/">AI工具大合集</a>
              </p>
              <p class="item-title">
                <a href="/posts/20230427a1.html" class="title">个人公众号赵KK日常技术记录     温馨提示本站所有资料仅供学习交流-严禁用于商业用途-请于24小时内删除</a>
              </p>
              <p class="item-date">
                <time datetime="2023-04-27T01:46:24.000Z" itemprop="datePublished">2023-04-27</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#If-I-have-seen-further-it-is-by-standing-on-the-shoulders-of-giants"><span class="toc-number">1.</span> <span class="toc-text">If I have seen further, it is by standing on the shoulders of giants</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%88%91%E6%AF%94%E5%88%AB%E4%BA%BA%E7%9C%8B%E5%BE%97%E6%9B%B4%E8%BF%9C-%E9%82%A3%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%88%91%E7%AB%99%E5%9C%A8%E5%B7%A8%E4%BA%BA%E7%9A%84%E8%82%A9%E8%86%80%E4%B8%8A"><span class="toc-number">2.</span> <span class="toc-text">如果我比别人看得更远,那是因为我站在巨人的肩膀上</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BB%8A%E5%9B%9E%E5%A4%B4%E7%9C%8B%E4%B8%8BServlet%E4%B8%8D%E4%BB%85%E5%A6%82%E6%AD%A4%E5%BC%BA%E5%A4%A7-%E8%BF%98%E5%85%B7%E6%9C%89%E5%BE%88%E5%BC%BA%E7%83%88%E7%9A%84%E5%8F%82%E8%80%83%E6%84%8F%E4%B9%89-%E8%83%BD%E5%9C%A8%E7%8E%B0%E5%A6%82%E4%BB%8A%E6%B5%81%E8%A1%8C%E7%9A%84%E5%A4%A7%E9%83%A8%E5%88%86%E6%A1%86%E6%9E%B6%E4%B8%AD%E6%89%BE%E5%88%B0%E5%AE%83%E7%9A%84%E5%BD%B1%E5%AD%90%E3%80%82%E4%B8%8B%E9%9D%A2%E6%96%87%E7%AB%A0%E4%B8%8D%E6%AD%A2%E4%B8%8E%E6%8E%A2%E7%B4%A2Servlet-%E5%8F%AF%E8%83%BD%E5%9C%A8%E5%85%B6%E4%B8%AD%E7%A9%BF%E6%8F%92%E5%85%B6%E4%BB%96%E7%9A%84%E5%85%B3%E8%81%94%E7%9F%A5%E8%AF%86%E7%82%B9-%E6%97%A8%E5%9C%A8%E8%83%BD%E4%BB%8E%E6%AD%A4%E6%AC%A1%E7%9A%84%E5%AD%A6%E4%B9%A0%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%9B%B4%E5%A4%9A%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E6%80%BB%E7%BB%93-%E8%BD%AC%E5%8C%96%E4%B8%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%90%86%E8%A7%A3%E8%BE%93%E5%87%BA-%E5%9C%A8%E6%96%87%E4%B8%AD%E6%88%91%E5%B0%BD%E9%87%8F%E4%BB%A5%E6%88%AA%E5%9B%BE-%E5%A4%8D%E5%88%B6%E5%85%A8%E9%99%90%E5%AE%9A%E7%B1%BB%E5%90%8D%E7%9A%84%E6%96%B9%E5%BC%8F%E8%AE%B0%E5%BD%95-%E4%BB%A5%E4%BE%BF%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E5%86%8D%E6%AC%A1%E6%9F%A5%E6%89%BE%E3%80%82"><span class="toc-number"></span> <span class="toc-text">如今回头看下Servlet不仅如此强大,还具有很强烈的参考意义,能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet,可能在其中穿插其他的关联知识点,旨在能从此次的学习中获取更多的知识点参考资料总结,转化为自己的理解输出,在文中我尽量以截图+复制全限定类名的方式记录,以便感兴趣的再次查找。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Springboot%E4%B8%8EServlet"><span class="toc-number"></span> <span class="toc-text">Springboot与Servlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number"></span> <span class="toc-text">生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87ServletContext"><span class="toc-number"></span> <span class="toc-text">应用上下文ServletContext</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-ApplicationContext"><span class="toc-number"></span> <span class="toc-text">SpringBoot ApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AutowireCapableBeanFactory"><span class="toc-number"></span> <span class="toc-text">AutowireCapableBeanFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6AbstractApplicationContext"><span class="toc-number"></span> <span class="toc-text">Spring容器内部工作机制AbstractApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getBeansWithAnnotation%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">getBeansWithAnnotation方法实例：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AnnotationConfigWebApplicationContext"><span class="toc-number"></span> <span class="toc-text">AnnotationConfigWebApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanPostProcessor-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number"></span> <span class="toc-text">BeanPostProcessor(后置处理器)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApplicationContextAware"><span class="toc-number"></span> <span class="toc-text">ApplicationContextAware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ResourceLoaderAware"><span class="toc-number"></span> <span class="toc-text">ResourceLoaderAware</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet%E4%B8%8EHttpServlet"><span class="toc-number"></span> <span class="toc-text">Servlet与HttpServlet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpServletResponse%E5%93%8D%E5%BA%94%E7%A0%81"><span class="toc-number"></span> <span class="toc-text">HttpServletResponse响应码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%99%A8%EF%BC%9A-%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E3%80%81%E6%A0%87%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">监听器：   实现接口、标记</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Servlet-on-Springboot"><span class="toc-number"></span> <span class="toc-text">Servlet on Springboot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%89%AB%E6%8F%8F%EF%BC%9AServletComponentScan"><span class="toc-number"></span> <span class="toc-text">组件扫描：ServletComponentScan</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#filter%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">filter：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BF%80%E6%B4%BBSpringbootweb"><span class="toc-number"></span> <span class="toc-text">激活Springbootweb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E8%A3%85SpringApplicationBuilder"><span class="toc-number"></span> <span class="toc-text">组装SpringApplicationBuilder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84Servlet%E5%AE%B9%E5%99%A8-Apache-Tomcat"><span class="toc-number"></span> <span class="toc-text">传统的Servlet容器 Apache Tomcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpServletResponse"><span class="toc-number"></span> <span class="toc-text">HttpServletResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86%E7%B1%BBorg-apache-catalina-servlets-DefaultServlet"><span class="toc-number"></span> <span class="toc-text">静态资源处理类org.apache.catalina.servlets.DefaultServlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%82%B9%E6%9D%A5%E4%BA%86-ServerProperties%E5%8C%85%E5%90%AB%E4%BA%86tomcat-Jetty-Undertow-%E8%80%8C%E5%9C%A8Springboot2-2-6%E4%B8%AD%E5%88%99%E5%AD%98%E5%9C%A8Netty"><span class="toc-number"></span> <span class="toc-text">重点来了 ServerProperties包含了tomcat,Jetty,Undertow,而在Springboot2.2.6中则存在Netty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%A3%E4%B9%88%E4%B8%BA%E4%BB%80%E4%B9%88Tomcat%E8%A2%AB%E7%A7%B0%E4%B9%8B%E4%B8%BA%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AE%B9%E5%99%A8%E5%91%A2%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">那么为什么Tomcat被称之为嵌入式容器呢？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%93%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%8F%91%E8%B5%B7%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">当一次请求发起都发生了什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%96%B9%E5%BA%93%E3%80%81%E4%BA%8C%E6%96%B9%E5%BA%93%E3%80%81%E4%B8%89%E6%96%B9%E5%BA%93%E8%AF%B4%E6%98%8E"><span class="toc-number"></span> <span class="toc-text">一方库、二方库、三方库说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBC%E4%B8%AD%E7%9A%84servlet"><span class="toc-number"></span> <span class="toc-text">JDBC中的servlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ResultSet-executeQuery-String-sql-throws-SQLException"><span class="toc-number"></span> <span class="toc-text">ResultSet executeQuery(String sql) throws SQLException;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CallerSensitive%E6%98%AF%E4%BB%80%E4%B9%88%E9%AC%BC%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">CallerSensitive是什么鬼？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95%E5%B0%B1%E6%98%AF%E5%AD%A6%E4%B9%A0%E5%A4%A7%E4%BD%AC%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="toc-number"></span> <span class="toc-text">学习方法就是学习大佬的学习方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89ConcurrentHashMap%E8%BF%98%E8%A6%81%E5%8A%A0%E5%85%A5synchronized"><span class="toc-number"></span> <span class="toc-text">为什么有ConcurrentHashMap还要加入synchronized</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%A7%81%E5%88%B0identityHashMap"><span class="toc-number"></span> <span class="toc-text">第二次见到identityHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E7%9D%80%E6%9D%A5%E7%9C%8B%E7%BC%93%E5%AD%98%E7%B1%BBCacheManager"><span class="toc-number"></span> <span class="toc-text">接着来看缓存类CacheManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BD%E9%99%85%E5%8C%96%E5%8C%85%E5%90%AB%E6%96%87%E6%9C%AC%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96%E5%92%8C%E6%97%B6%E5%8C%BA%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96"><span class="toc-number"></span> <span class="toc-text">国际化包含文本的国际化和时区的国际化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Repository-VS-NoRepositoryBean"><span class="toc-number"></span> <span class="toc-text">@Repository VS  @NoRepositoryBean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JMS-java-message-service-JSR-914"><span class="toc-number"></span> <span class="toc-text">JMS(java  message service)JSR-914</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%EF%BC%9F-%E5%93%8E%E5%97%A8-%E9%87%8D%E7%82%B9%E6%9D%A5%E4%BA%86"><span class="toc-number"></span> <span class="toc-text">3.kafka? 零拷贝？ 哎嗨,重点来了</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="toc-number"></span> <span class="toc-text">源码阅读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zookeeper%E4%B8%AD%E5%AD%98%E6%94%BE%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number"></span> <span class="toc-text">zookeeper中存放的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E6%96%B0%E5%A2%9E%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">Linux新增知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%82%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number"></span> <span class="toc-text">kafka服务器挂了怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Broker%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%8F%82%E6%95%B0"><span class="toc-number"></span> <span class="toc-text">Broker中的重要参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number"></span> <span class="toc-text">文件清理策略</span></a>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-[置顶]Springboot之---强大的Servlet" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      【置顶】Springboot之---强大的Servlet
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/posts/20220127clho7byh60014vwuj5v684524.html" class="article-date">
	  <time datetime="2022-01-27T01:45:49.000Z" itemprop="datePublished">2022-01-27</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Springboot/">Springboot</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Springboot/" rel="tag">Springboot</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/posts/20220127clho7byh60014vwuj5v684524.html#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 20.9k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 95(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <div id="readmore-container"><h4 id="If-I-have-seen-further-it-is-by-standing-on-the-shoulders-of-giants"><a href="#If-I-have-seen-further-it-is-by-standing-on-the-shoulders-of-giants" class="headerlink" title="If I have seen further, it is by standing on the shoulders of giants"></a>If I have seen further, it is by standing on the shoulders of giants</h4><h4 id="如果我比别人看得更远-那是因为我站在巨人的肩膀上"><a href="#如果我比别人看得更远-那是因为我站在巨人的肩膀上" class="headerlink" title="如果我比别人看得更远,那是因为我站在巨人的肩膀上"></a>如果我比别人看得更远,那是因为我站在巨人的肩膀上</h4><h3 id="如今回头看下Servlet不仅如此强大-还具有很强烈的参考意义-能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet-可能在其中穿插其他的关联知识点-旨在能从此次的学习中获取更多的知识点参考资料总结-转化为自己的理解输出-在文中我尽量以截图-复制全限定类名的方式记录-以便感兴趣的再次查找。"><a href="#如今回头看下Servlet不仅如此强大-还具有很强烈的参考意义-能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet-可能在其中穿插其他的关联知识点-旨在能从此次的学习中获取更多的知识点参考资料总结-转化为自己的理解输出-在文中我尽量以截图-复制全限定类名的方式记录-以便感兴趣的再次查找。" class="headerlink" title="如今回头看下Servlet不仅如此强大,还具有很强烈的参考意义,能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet,可能在其中穿插其他的关联知识点,旨在能从此次的学习中获取更多的知识点参考资料总结,转化为自己的理解输出,在文中我尽量以截图+复制全限定类名的方式记录,以便感兴趣的再次查找。"></a>如今回头看下Servlet不仅如此强大,还具有很强烈的参考意义,能在现如今流行的大部分框架中找到它的影子。下面文章不止与探索Servlet,可能在其中穿插其他的关联知识点,旨在能从此次的学习中获取更多的知识点参考资料总结,转化为自己的理解输出,在文中我尽量以截图+复制全限定类名的方式记录,以便感兴趣的再次查找。</h3><h2 id="Springboot与Servlet"><a href="#Springboot与Servlet" class="headerlink" title="Springboot与Servlet"></a>Springboot与Servlet</h2><p>在springboot中内嵌了Tomcat容器,而Tomcat又是Servlet的容器,Springboot就与Servlet产生了紧密的联系。<br>在分析各个类时,注意下每个类所在的包是如何在tomcat与boot之间跨越的~</p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p>1、初始化<br>2、处理请求<br>3、销毁<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet.png" alt="流程"></p>
<h3 id="应用上下文ServletContext"><a href="#应用上下文ServletContext" class="headerlink" title="应用上下文ServletContext"></a>应用上下文ServletContext</h3><p>应用上下文即可看做：一次请求到达,到响应结束的过程中间的catlog,即阅读中结合上下文语境,是一个广义定义。<br>为什么说到上下文呢？来看下ServletContext的实现,第一个经典实现既是ApplicationContext我们不止在一次源码和应用中见到它,另外加载器目前有两种选择：ContextLoaderListener和ContextLoaderServlet。其功能是完全相同。会在下文进行介绍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Standard implementation of &lt;code&gt;ServletContext&lt;/code&gt; that represents</span></span><br><span class="line"><span class="comment"> * a web application&#x27;s execution environment.  An instance of this class is</span></span><br><span class="line"><span class="comment"> * associated with each instance of &lt;code&gt;StandardContext&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> * 代表web应用程序的执行环境。这个类的一个实例是</span></span><br><span class="line"><span class="comment"> *与StandardContext的每个实例关联。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Craig R. McClanahan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Remy Maucherat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContext</span> <span class="keyword">implements</span> <span class="title">ServletContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> STRICT_SERVLET_COMPLIANCE;<span class="comment">///翻译为是否严格遵守</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> GET_RESOURCE_REQUIRE_SLASH;<span class="comment">//获取资源是否需要斜线。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        STRICT_SERVLET_COMPLIANCE = Globals.STRICT_SERVLET_COMPLIANCE;</span><br><span class="line"></span><br><span class="line">        String requireSlash = System.getProperty(<span class="string">&quot;org.apache.catalina.core.ApplicationContext.GET_RESOURCE_REQUIRE_SLASH&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (requireSlash == <span class="keyword">null</span>) &#123;</span><br><span class="line">            GET_RESOURCE_REQUIRE_SLASH = STRICT_SERVLET_COMPLIANCE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            GET_RESOURCE_REQUIRE_SLASH = Boolean.parseBoolean(requireSlash);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注：特别重要上述配置为tomcat中第一个开关配置,决定多个属性的值。来自于下面的Globals.STRICT_SERVLET_COMPLIANCE;默认为false<br>验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> STRICT_SERVLET_COMPLIANCE =Boolean.parseBoolean(System.getProperty(<span class="string">&quot;org.apache.catalina.STRICT_SERVLET_COMPLIANCE&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>和官网截图<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/compliance.png" alt="流程"><br>问题:会因为tomcat的版本配置不同改变此值,在8.5.57当中会改变为true,当controller中配置多个映射路径会出现访问不到的问题<br>此处参考博文：<a target="_blank" rel="noopener" href="https://blog.csdn.net/xing930408/article/details/111225064">https://blog.csdn.net/xing930408/article/details/111225064</a><br>Tomcat文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/config/systemprops.html">https://tomcat.apache.org/tomcat-8.5-doc/config/systemprops.html</a><br>而GET_RESOURCE_REQUIRE_SLASH直接赋值为STRICT_SERVLET_COMPLIANCE</p>
<h2 id="SpringBoot-ApplicationContext"><a href="#SpringBoot-ApplicationContext" class="headerlink" title="SpringBoot ApplicationContext"></a>SpringBoot ApplicationContext</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface ApplicationContext extends EnvironmentCapable, ListableBeanFactory, HierarchicalBeanFactory,MessageSource, ApplicationEventPublisher, ResourcePatternResolver</span><br></pre></td></tr></table></figure>

<p>都在说ApplicationContext衍生了BeanFactory那么对此都扩展了那些功能？ApplicationContext定了高级容器的基本规范,其实他也不是直接继承BeanFactory基础容器,可以看到ApplicationContext的直接父接口对BeanFactory进行很多拓展其中就包括：<br>1.事件的注册和发布<br>2.消息解析<br>3.资源解析<br>4.Bean工厂层级管理<br>5.监听器<br>6.容器环境<br>通过以上拓展,我们基本可以知道高级IOC容器有哪些特点,这也是学习整个ApplicationContext容器重点了解的部分</p>
<p>再比较ApplicationContext和ConfigurableApplicationContext定义的方法以及下图层级关系,ConfigurableApplicationContext是ApplicationContext的子接口,也就包含了ApplicationContext。通过方法可以知道,ConfigurableApplicationContext重在对各种属性的配置,而ApplicationContext接口主要各种属性的get方法。</p>
<p>Spring这种将get和set分开到两个接口的设计增大了属性设置和获取的灵活性,将两者分开也更加清晰。在以后的解决方案设计中,可以参考,将配置信息和获取信息分开,两者互不干扰,在保证重要的基础属性不变的情况,可以按需进行拓展。其实Spring的框架设计中应用了大量的装饰者模式,这也是高拓展点的需要</p>
<p>该类提供了高级IOC规范<br>其中有几个注意点：</p>
<p>从ListableBeanFactory接口继承来的：用于访问应用组件的工厂方法<br>从ResourceLoader接口继承来的：用通用的方式加载文件资源<br>从ApplicationEventPublisher接口继承来的：注册和发布事件<br>从MessageSource接口继承来的：处理消息,支持国际化</p>
<p>从父应用上下文定义的在子上下文中将始终保持优先</p>
<p><a target="_blank" rel="noopener" href="https://www.javaguides.net/2019/10/how-to-get-application-context-in-spring-boot.html">https://www.javaguides.net/2019/10/how-to-get-application-context-in-spring-boot.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public interface ApplicationContext extends EnvironmentCapable, ListableBeanFactory, HierarchicalBeanFactory,</span><br><span class="line">        MessageSource, ApplicationEventPublisher, ResourcePatternResolver &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 返回一个唯一的应用上下文id+</span><br><span class="line">     * @return the unique id of the context, or &#123;@code null&#125; if none</span><br><span class="line">     */</span><br><span class="line">    @Nullable</span><br><span class="line">    String getId();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 返回已经部署的该应用上下文的名称.</span><br><span class="line">     * @return a name for the deployed application, or the empty String by default</span><br><span class="line">     */</span><br><span class="line">    String getApplicationName();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 返回此上下文友好的名称---这有什么用呢？</span><br><span class="line">     * @return a display name for this context (never &#123;@code null&#125;)</span><br><span class="line">     */</span><br><span class="line">    String getDisplayName();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 返回该上下文第一次被加载的时间戳</span><br><span class="line">     * @return the timestamp (ms) when this context was first loaded</span><br><span class="line">     */</span><br><span class="line">    long getStartupDate();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *返回父应用上下文, 如果没有父上下文,该上下文就是在上下文层次的根</span><br><span class="line">     * @return the parent context, or &#123;@code null&#125; if there is no parent</span><br><span class="line">     */</span><br><span class="line">    @Nullable</span><br><span class="line">    ApplicationContext getParent();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    AutowireCapableBeanFactory getAutowireCapableBeanFactory() throws IllegalStateException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这其中对AutowireCapableBeanFactory getAutowireCapableBeanFactory()方法有疑惑,然后网上百度了一下。Spring提供了一种机制,能够为第三方框架赋能,让Spring去管理的Bean去装配和填充那些没有被SpringIOC管理的bean。也就是Spring提供了使用第三方框架的能力,能够做到无缝的将第三方框架整合到Spring中来进行使用,Junit与Quartz借用了这种机制为自己赋能。</p>
<p>————————————————<br>版权声明：本文为CSDN博主「还你一梦」的原创文章,遵循CC 4.0 BY-SA版权协议,转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ligel136738/article/details/113533132">https://blog.csdn.net/ligel136738/article/details/113533132</a></p>
<h2 id="AutowireCapableBeanFactory"><a href="#AutowireCapableBeanFactory" class="headerlink" title="AutowireCapableBeanFactory"></a>AutowireCapableBeanFactory</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">package org.springframework.beans.factory.config;</span><br><span class="line"></span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.BeansException;</span><br><span class="line">import org.springframework.beans.TypeConverter;</span><br><span class="line">import org.springframework.beans.factory.BeanFactory;</span><br><span class="line">import org.springframework.beans.factory.NoSuchBeanDefinitionException;</span><br><span class="line">import org.springframework.beans.factory.NoUniqueBeanDefinitionException;</span><br><span class="line">import org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public interface AutowireCapableBeanFactory extends BeanFactory &#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    int AUTOWIRE_NO = 0;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    int AUTOWIRE_BY_NAME = 1;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    int AUTOWIRE_BY_TYPE = 2;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    int AUTOWIRE_CONSTRUCTOR = 3;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    @Deprecated</span><br><span class="line">    int AUTOWIRE_AUTODETECT = 4;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    String ORIGINAL_INSTANCE_SUFFIX = &quot;.ORIGINAL&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;T&gt; T createBean(Class&lt;T&gt; beanClass) throws BeansException;</span><br><span class="line"></span><br><span class="line">    void autowireBean(Object existingBean) throws BeansException;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    Object configureBean(Object existingBean, String beanName) throws BeansException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Object createBean(Class&lt;?&gt; beanClass, int autowireMode, boolean dependencyCheck) throws BeansException;</span><br><span class="line"></span><br><span class="line">    Object autowire(Class&lt;?&gt; beanClass, int autowireMode, boolean dependencyCheck) throws BeansException;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    void autowireBeanProperties(Object existingBean, int autowireMode, boolean dependencyCheck)</span><br><span class="line">            throws BeansException;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    void applyBeanPropertyValues(Object existingBean, String beanName) throws BeansException;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    Object initializeBean(Object existingBean, String beanName) throws BeansException;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)</span><br><span class="line">            throws BeansException;</span><br><span class="line"></span><br><span class="line">    Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)</span><br><span class="line">            throws BeansException;</span><br><span class="line"></span><br><span class="line">    void destroyBean(Object existingBean);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    &lt;T&gt; NamedBeanHolder&lt;T&gt; resolveNamedBean(Class&lt;T&gt; requiredType) throws BeansException;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    @Nullable</span><br><span class="line">    Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName) throws BeansException;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    @Nullable</span><br><span class="line">    Object resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName,</span><br><span class="line">            @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在ApplacationContext中并没有实现此工厂接口,如上文可见,是在初始化Spring管理Bean之外的实例时直接调用getAutowireCapableBeanFactory方法<br>AutowireCapableBeanFactory定义了5种装配策略：</p>
<p>不自动注入：AUTOWIRE_NO<br>使用BeanName策略注入：AUTOWIRE_BY_NAME<br>使用类型装配策略：AUTOWIRE_BY_TYPE<br>使用构造器装配策略：AUTOWIRE_CONSTRUCTOR<br>自动装配策略：AUTOWIRE_AUTODETECT</p>
<p>以AbstractAutowireCapableBeanFactory为例,其实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">autowireBean</span><span class="params">(Object existingBean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用非单例bean定义,以避免将bean注册为依赖bean</span></span><br><span class="line">        <span class="comment">// Use non-singleton bean definition, to avoid registering bean as dependent bean.</span></span><br><span class="line">        RootBeanDefinition bd = <span class="keyword">new</span> RootBeanDefinition(ClassUtils.getUserClass(existingBean));</span><br><span class="line">        Bean的作用域</span><br><span class="line">        bd.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span><br><span class="line">        检查给定类在给定上下文中是否是缓存安全的,</span><br><span class="line">        即它是由给定类加载器加载还是由其父级加载。类加载器</span><br><span class="line">        bd.allowCaching = ClassUtils.isCacheSafe(bd.getBeanClass(), getBeanClassLoader());</span><br><span class="line">        BeanWrapper bw = <span class="keyword">new</span> BeanWrapperImpl(existingBean);</span><br><span class="line">        初始化BeanRapper并创建</span><br><span class="line">        initBeanWrapper(bw);</span><br><span class="line">        实际上该方法的逻辑主要是在populateBean中。这个方法是Spring中一个重要的方法。用于装配Bean。主要是通过反射获取到我们<span class="keyword">new</span>出来的对象的属性及注解,若是注解时Autowired、Value、Inject时,进行Bean组装。此方法执行完毕,我们<span class="keyword">new</span>出来的方法就可以通过注解注入的bean进行操作了</span><br><span class="line">        作者：小胖学编程</span><br><span class="line">        链接：https:<span class="comment">//www.jianshu.com/p/14dd69b5c516</span></span><br><span class="line">        来源：简书</span><br><span class="line">        著作权归作者所有。商业转载请联系作者获得授权,非商业转载请注明出处。</span><br><span class="line">        populateBean(bd.getBeanClass().getName(), bd, bw);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring容器内部工作机制AbstractApplicationContext"><a href="#Spring容器内部工作机制AbstractApplicationContext" class="headerlink" title="Spring容器内部工作机制AbstractApplicationContext"></a>Spring容器内部工作机制AbstractApplicationContext</h2><p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/ApplicationContext.jpg" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.AbstractApplicationContext</span><br><span class="line"><span class="keyword">package</span> org.springframework.context.support;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用模板方法设计模式,需要具体的子类来实现抽象方法。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title">DefaultResourceLoader</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ConfigurableApplicationContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在此工厂中,国际化消息 MessageSource 的 bean的名称。</span></span><br><span class="line"><span class="comment">     * 如果没有提供消息,消息解析将委托给父节点。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> MessageSource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MESSAGE_SOURCE_BEAN_NAME = <span class="string">&quot;messageSource&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在此工厂中,SpringBean 的生命周期LifecycleProcessor 的 bean的名称</span></span><br><span class="line"><span class="comment">     * 如果没有提供,则使用DefaultLifecycleProcessor。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.LifecycleProcessor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.support.DefaultLifecycleProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIFECYCLE_PROCESSOR_BEAN_NAME = <span class="string">&quot;lifecycleProcessor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在此工厂中,应用事件多路广播器 的 bean的名称。</span></span><br><span class="line"><span class="comment">     * 如果没有提供,则使用默认的simpleapplicationeventmultiaster。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.event.ApplicationEventMulticaster</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String APPLICATION_EVENT_MULTICASTER_BEAN_NAME = <span class="string">&quot;applicationEventMulticaster&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ContextClosedEvent.class.getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 这个类使用的logger。可用于子类。 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 此上下文的唯一id(如果有的话)。 */</span></span><br><span class="line">    <span class="keyword">private</span> String id = ObjectUtils.identityToString(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 显示名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String displayName = ObjectUtils.identityToString(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 父上下文。 */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext parent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 此上下文使用的环境。 */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 应用于刷新的 BeanFactoryPostProcessors */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 此上下文启动时的系统时间(毫秒)。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startupDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 指示此上下文当前是否处于活动状态的标志。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean active = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 指示此上下文是否已关闭的标志。 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean closed = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用于&quot;刷新&quot; 和 &quot;销毁&quot; 时的同步监视器（浅显是说就是当做锁） */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object startupShutdownMonitor = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 如果已注册,则引用JVM关闭链接。 */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Thread shutdownHook;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 此上下文使用的 ResourcePatternResolver 资源模式解析器 */</span></span><br><span class="line">    <span class="keyword">private</span> ResourcePatternResolver resourcePatternResolver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** LifecycleProcessor 生命周期处理器,用于在此上下文中管理bean的生命周期。 */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> LifecycleProcessor lifecycleProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 我们将这个接口的实现委托给 MessageSource */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> MessageSource messageSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 事件发布所使用的助手类。 */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 静态的、指定的 listeners 监听器Set集合. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 早期发布的 ApplicationEvents 应用事件Set集合. */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;ApplicationEvent&gt; earlyApplicationEvents;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 创建一个没有父元素的新的AbstractApplicationContext。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resourcePatternResolver = getResourcePatternResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 使用给定的父上下文来创建一个新的AbstractApplicationContext。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractApplicationContext</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">        setParent(parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// ApplicationContext接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置此应用程序上下文的惟一id。</span></span><br><span class="line"><span class="comment">     * 默认值是上下文实例的对象id,或者上下文bean的名称(如果上下文本身定义为bean的话)。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 上下文的唯一id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** 获取此应用程序上下文的id。 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getApplicationName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为这个上下文设置一个(显示)名称。</span></span><br><span class="line"><span class="comment">     * 通常在具体上下文实现的初始化过程中完成。</span></span><br><span class="line"><span class="comment">     * 默认值是上下文实例的对象id。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayName</span><span class="params">(String displayName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置显示的上下文名称不能为空</span></span><br><span class="line">        Assert.hasLength(displayName, <span class="string">&quot;Display name must not be empty&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.displayName = displayName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取并返回此应用上下文的展示名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 此应用上下文的展示名称（非null）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.displayName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回父上下文,如果没有父上下文,则返回 null。</span></span><br><span class="line"><span class="comment">     * (返回null意为着,此应用上下文是整个应用上下文体系的根上下文）。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationContext <span class="title">getParent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为这个应用程序上下文设置 Environment 环境</span></span><br><span class="line"><span class="comment">     * 默认值由 createEnvironment()方法决定。</span></span><br><span class="line"><span class="comment">     * 用这个方法替换默认值不是唯一选择,还可通过 getEnvironment() 方法进行配置。</span></span><br><span class="line"><span class="comment">     * 但不管在哪一种情况下,这些修改都应该在 refresh() 方法前执行。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.support.AbstractApplicationContext#createEnvironment</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取并返回此应用上下文的环境,如果为null,则通过 createEnvironment() 方法进行创建并返回。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigurableEnvironment <span class="title">getEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.environment = createEnvironment();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建并返回新的StandardEnvironment 标准环境。</span></span><br><span class="line"><span class="comment">     * 子类可以重写此方法,以便提供自定义 ConfigurableEnvironment 可配置环境的实现。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableEnvironment <span class="title">createEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果此应用上下文已经可用,则将此上下文的内部bean工厂返回为AutowireCapableBeanFactory。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getBeanFactory()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AutowireCapableBeanFactory <span class="title">getAutowireCapableBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 在首次加载此上下文时返回时间戳(ms)。 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStartupDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.startupDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将给定的事件发布给所有监听器。</span></span><br><span class="line"><span class="comment">     * 注意:监听器在 MessageSource 之后初始化,以便能够在监听器实现中访问它。</span></span><br><span class="line"><span class="comment">     * 因此,MessageSource 实现不能发布事件。要发布的事件(可能是特定于应用程序或标准框架事件)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        publishEvent(event, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将给定的事件发布给所有监听器。</span></span><br><span class="line"><span class="comment">     * 注意:监听器在 MessageSource 之后初始化,以便能够在监听器实现中访问它。</span></span><br><span class="line"><span class="comment">     * 因此,MessageSource 实现不能发布事件。</span></span><br><span class="line"><span class="comment">     * 要发布的事件(可能是 ApplicationEvent 或要转换为 PayloadApplicationEvent 的有效负载对象)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        publishEvent(event, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将给定的事件发布给所有监听器。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event 要发布的事件(可能是 ApplicationEvent 或要转换为 PayloadApplicationEvent 的有效负载对象)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType 可解析的事件类型(如果已知)（前面的文章已经提到过）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必要时将事件装饰为 ApplicationEvent</span></span><br><span class="line">        ApplicationEvent applicationEvent;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) &#123;</span><br><span class="line">            applicationEvent = (ApplicationEvent) event;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            applicationEvent = <span class="keyword">new</span> PayloadApplicationEvent&lt;&gt;(<span class="keyword">this</span>, event);</span><br><span class="line">            <span class="keyword">if</span> (eventType == <span class="keyword">null</span>) &#123;</span><br><span class="line">                eventType = ((PayloadApplicationEvent) applicationEvent).getResolvableType();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果可能的话,现在就进行多播——或者在初始化多播器之后延迟</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过父上下文发布事件…</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">                ((AbstractApplicationContext) <span class="keyword">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.parent.publishEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回上下文使用的内部 ApplicationEventMulticaster 应用事件多路广播器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 上下文使用的内部 ApplicationEventMulticaster 应用事件多路广播器（从不为null）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException 如果上下文尚未初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ApplicationEventMulticaster <span class="title">getApplicationEventMulticaster</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.applicationEventMulticaster == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;ApplicationEventMulticaster not initialized - &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;call &#x27;refresh&#x27; before multicasting events via the context: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.applicationEventMulticaster;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回上下文使用的内部生命周期处理器。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 内部生命周期处理器。 (从不为null)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException 如果上下文尚未初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LifecycleProcessor <span class="title">getLifecycleProcessor</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;LifecycleProcessor not initialized - &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;call &#x27;refresh&#x27; before invoking lifecycle methods via the context: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.lifecycleProcessor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回此 ResourcePatternResolver资源模式解析器,</span></span><br><span class="line"><span class="comment">     * 用于将多个资源的位置按照模式解析到资源实例中。</span></span><br><span class="line"><span class="comment">     * 默认是org.springframework.core.io.support.PathMatchingResourcePatternResolver。</span></span><br><span class="line"><span class="comment">     * 支持ant风格的位置模式。</span></span><br><span class="line"><span class="comment">     * 可以在子类中重写,用于扩展解析策略,例如在web环境中。在需要解决位置模式时不要调用此函数。</span></span><br><span class="line"><span class="comment">     * 相反,调用上下文的getResources方法,它将委托给ResourcePatternResolver。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 此应用上下文的 ResourcePatternResolver 资源模式解析器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getResources</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ResourcePatternResolver <span class="title">getResourcePatternResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PathMatchingResourcePatternResolver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// ConfigurableApplicationContext接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置此应用程序上下文的父上下文。</span></span><br><span class="line"><span class="comment">     * 父级ApplicationContext#getEnvironment()环境是</span></span><br><span class="line"><span class="comment">     * ConfigurableEnvironment#merge(ConfigurableEnvironment),如果父级非null,</span></span><br><span class="line"><span class="comment">     * 并且它的环境是ConfigurableEnvironment的实例,那么它就会与这个(子级)应用程序上下文环境合并</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ConfigurableEnvironment#merge(ConfigurableEnvironment)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParent</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Environment parentEnvironment = parent.getEnvironment();</span><br><span class="line">            <span class="keyword">if</span> (parentEnvironment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">                getEnvironment().merge((ConfigurableEnvironment) parentEnvironment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 添加Bean工厂后置处理器 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor postProcessor)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(postProcessor, <span class="string">&quot;BeanFactoryPostProcessor must not be null&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.beanFactoryPostProcessors.add(postProcessor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回将应用到内部BeanFactory的BeanFactoryPostProcessors列表。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;BeanFactoryPostProcessor&gt; <span class="title">getBeanFactoryPostProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.beanFactoryPostProcessors;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 添加应用上下文监听器 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(listener, <span class="string">&quot;ApplicationListener must not be null&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.applicationEventMulticaster != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.applicationEventMulticaster.addApplicationListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回静态指定的ApplicationListeners集合.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.applicationListeners;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载或刷新一个持久化的配置,可能是XML文件、属性文件或关系数据库模式。</span></span><br><span class="line"><span class="comment">     * 由于这是一种启动方法,如果失败,应该销毁已经创建的单例,以避免悬空资源。</span></span><br><span class="line"><span class="comment">     * 换句话说,在调用该方法之后,要么全部实例化,要么完全不实例化。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> 如果bean工厂无法初始化,则抛出 BeansException 异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> 如果已经初始化且不支持多次刷新,则会抛出 IllegalStateException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">        <span class="comment">// 加载或刷新配置前的同步处理</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="comment">// 为刷新而准备此上下文</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 告诉子类去刷新内部bean工厂。</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备好bean工厂,以便在此上下文中使用。</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 允许在上下文子类中对bean工厂进行后置处理。</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用在上下文中注册为bean的工厂处理器。</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 注册拦截bean创建的bean处理器。</span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化此上下文的 message resource 消息资源。</span></span><br><span class="line">                initMessageSource();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为这个上下文初始化事件多路广播器。</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化特定上下文子类中的其他特殊bean。</span></span><br><span class="line">                onRefresh();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 注册监听器（检查监听器的bean并注册它们）。</span></span><br><span class="line">                registerListeners();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 实例化所有剩余的(非 lazy-init 懒初始化的)单例。</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最后一步: 发布相应的事件。</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 销毁已经创建的单例,以避免悬空资源。</span></span><br><span class="line">                destroyBeans();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重置 &#x27;active&#x27; 表示.</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将异常传播给调用者。</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 重置Spring内核中的共用的缓存,因为我们可能再也不需要单例bean的元数据了……</span></span><br><span class="line">                resetCommonCaches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备这个上下文来刷新、设置它的启动日期和活动标志以及执行属性源的任何初始化。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Refreshing &quot;</span> + getDisplayName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在此上下文环境中,初始化任何占位符处的属性资源</span></span><br><span class="line">        initPropertySources();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证标记为必需的所有属性是否可解析</span></span><br><span class="line">        <span class="comment">// 请参考 ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">        getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许在多路广播器可用时,就会发布初期 ApplicationEvents 应用事件的集合</span></span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用实际实例替换任何存根属性源。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.core.env.PropertySource.StubPropertySource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.web.context.support.WebApplicationContextUtils#initServletPropertySources</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initPropertySources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对于子类：默认情况下不执行任何操作。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知此上下文的子类去加载或刷新其内在的bean工厂</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 新的bean工厂实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #refreshBeanFactory()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getBeanFactory()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        refreshBeanFactory();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置工厂的标准上下文的特征属性,</span></span><br><span class="line"><span class="comment">     * 例如上下文的ClassLoader类加载器和post-processors后置处理器。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory 要配置的bean工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 告诉内部bean工厂使用上下文的类加载器等。</span></span><br><span class="line">        beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">        beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">        beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用上下文回调配置bean工厂。</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">        beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在简单的工厂中,BeanFactory接口没有注册为可解析的类型。</span></span><br><span class="line">        <span class="comment">// MessageSource注册（并发现自动）为一个bean。</span></span><br><span class="line">        beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">        beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">        beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">        beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册早期后置处理器,用于检测内部bean作为应用程序监听器。</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如何找到一个LoadTimeWeaver,那么就准备将后置处理器“织入”bean工厂</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">            <span class="comment">// 为类型匹配设置临时类加载器。</span></span><br><span class="line">            beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册默认environment环境bean。</span></span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在标准初始化后修改应用程序上下文的内部bean工厂。</span></span><br><span class="line"><span class="comment">     * 所有bean定义都将被加载,但是没有bean会被实例化。</span></span><br><span class="line"><span class="comment">     * 这允许在某些应用上下文实现中注册特殊的BeanPostProcessors等。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanFactory 应用环境下的Bean工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实例化并调用所有已注册的BeanFactoryPostProcessor 的 bean,如果已给出顺序,请按照顺序。</span></span><br><span class="line"><span class="comment">     * 必须在单实例实例化之前调用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如何找到一个LoadTimeWeaver,那么就准备将后置处理器“织入”bean工厂</span></span><br><span class="line">        <span class="comment">// (例如,一个 @Bean 方法通过ConfigurationClassPostProcessor来注册)</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">            beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">            beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BeanPostProcessor 的 bean,如果给出显式顺序,请按照顺序。</span></span><br><span class="line"><span class="comment">     * 必须在应用程序bean的任何实例化之前调用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化MessageSource。</span></span><br><span class="line"><span class="comment">     * 如果在此上下文中未定义国际化资源,则使用父上下文的国际化资源。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">            <span class="comment">// 使用此上下文的 MessageSource 知道父上下文的 MessageSource.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageSource <span class="keyword">instanceof</span> HierarchicalMessageSource) &#123;</span><br><span class="line">                HierarchicalMessageSource hms = (HierarchicalMessageSource) <span class="keyword">this</span>.messageSource;</span><br><span class="line">                <span class="keyword">if</span> (hms.getParentMessageSource() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果没有已注册的父MessageSource,则只将父上下文设置为父MessageSource</span></span><br><span class="line">                    <span class="comment">// registered already.</span></span><br><span class="line">                    hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Using MessageSource [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 使用空MessageSource可以接受getMessage方法的调用。</span></span><br><span class="line">            DelegatingMessageSource dms = <span class="keyword">new</span> DelegatingMessageSource();</span><br><span class="line">            dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">            <span class="keyword">this</span>.messageSource = dms;</span><br><span class="line">            beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, <span class="keyword">this</span>.messageSource);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + MESSAGE_SOURCE_BEAN_NAME + <span class="string">&quot;&#x27; bean, using [&quot;</span> + <span class="keyword">this</span>.messageSource + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化ApplicationEventMulticaster。</span></span><br><span class="line"><span class="comment">     * 如果在上下文中没有定义,则使用SimpleApplicationEventMulticaster。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.event.SimpleApplicationEventMulticaster</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">                    beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">            beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化LifecycleProcessor.</span></span><br><span class="line"><span class="comment">     * 如果在当前上下文中没有定义,则使用 DefaultLifecycleProcessor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.support.DefaultLifecycleProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initLifecycleProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lifecycleProcessor =</span><br><span class="line">                    beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Using LifecycleProcessor [&quot;</span> + <span class="keyword">this</span>.lifecycleProcessor + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            DefaultLifecycleProcessor defaultProcessor = <span class="keyword">new</span> DefaultLifecycleProcessor();</span><br><span class="line">            defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">            <span class="keyword">this</span>.lifecycleProcessor = defaultProcessor;</span><br><span class="line">            beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, <span class="keyword">this</span>.lifecycleProcessor);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;No &#x27;&quot;</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span class="string">&quot;&#x27; bean, using &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;[&quot;</span> + <span class="keyword">this</span>.lifecycleProcessor.getClass().getSimpleName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板方法,可以重写以添加特定于上下文的刷新工作。</span></span><br><span class="line"><span class="comment">     * 在特殊实例实例化之前调用特殊bean的初始化。</span></span><br><span class="line"><span class="comment">     * 此实现为空。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException in case of errors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #refresh()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// 对于子类：默认情况下不做任何事情。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加应用程序监听器作为监听器的bean。</span></span><br><span class="line"><span class="comment">     * 不影响其他监听器,可以在没有bean的情况下添加。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 首先注册静态的指定的监听器。</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">            getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不要在这里初始化factorybean:我们需要保留所有未初始化的常规bean,让后处理器应用到它们!</span></span><br><span class="line">        String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">            getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 现在我们最终拥有一个多路广播器来发布早期的应用程序事件......</span></span><br><span class="line">        Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">                getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 完成此上下文的bean工厂的初始化,初始化所有剩余的单例bean。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化此上下文的转换服务conversion service。</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">                beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">            beanFactory.setConversionService(</span><br><span class="line">                    beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有bean后置处理器post-processor,则注册默认嵌入式值解析器</span></span><br><span class="line">        <span class="comment">// (例如像一个 PropertyPlaceholderConfigurer bean) 以前任何注册过:</span></span><br><span class="line">        <span class="comment">// 此时,主要用于注释属性值的解析。</span></span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">            beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尽早初始化LoadTimeWeaverAware bean,以便尽早注册它们的transformers。</span></span><br><span class="line">        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">            getBean(weaverAwareName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 停止使用临时类加载器进行类型匹配。</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许缓存所有bean定义元数据,不希望有进一步的更改。</span></span><br><span class="line">        beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化所有剩余的(non-lazy-init非延时加载的)单例。</span></span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 完成此上下文的刷新,调用LifecycleProcessor的onRefresh()方法</span></span><br><span class="line"><span class="comment">     * 并发布org.springframework.context.event.ContextRefreshedEvent 事件.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 清除上下文级别的资源缓存(如扫描的ASM元数据)。</span></span><br><span class="line">        clearResourceCaches();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为这个上下文初始化生命周期处理器。</span></span><br><span class="line">        initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先将刷新传播到生命周期处理器。</span></span><br><span class="line">        getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发布最终事件。</span></span><br><span class="line">        publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如何处于激活状态,将参与到 LiveBeansView MBean 中</span></span><br><span class="line">        LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消此上下文的刷新尝试,在抛出异常后重置 active 标志。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex 导致取消的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">cancelRefresh</span><span class="params">(BeansException ex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重置Spring的共同的反射元数据缓存,</span></span><br><span class="line"><span class="comment">     * 特别是 ReflectionUtils, AnnotationUtils, ResolvableType</span></span><br><span class="line"><span class="comment">     * 和 CachedIntrospectionResults 缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 4.2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ReflectionUtils#clearCache()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> AnnotationUtils#clearCache()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ResolvableType#clearCache()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CachedIntrospectionResults#clearClassLoader(ClassLoader)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetCommonCaches</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ReflectionUtils.clearCache();</span><br><span class="line">        AnnotationUtils.clearCache();</span><br><span class="line">        ResolvableType.clearCache();</span><br><span class="line">        CachedIntrospectionResults.clearClassLoader(getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向JVM运行时注册一个关闭链接,在JVM关闭时关闭这个上下文,除非此时它已经关闭。</span></span><br><span class="line"><span class="comment">     * 委托给 doClose() 方法去关闭,用于实际的关闭过程。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> Runtime#addShutdownHook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #close()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #doClose()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.shutdownHook == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 尚未注册关机链接</span></span><br><span class="line">            <span class="keyword">this</span>.shutdownHook = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (startupShutdownMonitor) &#123;</span><br><span class="line">                        doClose();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">this</span>.shutdownHook);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于销毁此实例的回调,最初附加到 DisposableBean 的实现(spring 5.0中不再存在)。 </span></span><br><span class="line"><span class="comment">     * close() 方法是关闭 ApplicationContext 本应用上下文的方法,</span></span><br><span class="line"><span class="comment">     * 该destroy()方法只是委托给close()方法。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> 从Spring Framework 5.0开始,本方法被标记为过时,而支持 close()方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭此应用程序上下文,销毁其bean工厂中的所有bean。</span></span><br><span class="line"><span class="comment">     * 实际关闭过程是委派 doClose()方法。</span></span><br><span class="line"><span class="comment">     * 同时,如果已在JVM注册了关闭链接,也删除其关闭链接,因为它不再需要了。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #doClose()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #registerShutdownHook()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            doClose();</span><br><span class="line">            <span class="comment">// 如果已在JVM注册了关闭链接,现在我们不再需要它了：</span></span><br><span class="line">            <span class="comment">// 我们已经明确地关闭了上下文。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.shutdownHook != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().removeShutdownHook(<span class="keyword">this</span>.shutdownHook);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                    <span class="comment">// 忽略已经关闭的VM</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实际上执行上下文关闭:</span></span><br><span class="line"><span class="comment">     * 发布ContextClosedEvent山下文关闭事件,并销毁此应用程序上下文的bean工厂中的单例对象。</span></span><br><span class="line"><span class="comment">     * 如果有的话,则调用 close() 方法和一个JVM关闭链接。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #destroyBeans()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #close()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #registerShutdownHook()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.active.get() &amp;&amp; <span class="keyword">this</span>.closed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Closing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LiveBeansView.unregisterApplicationContext(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 发布上下文关闭事件</span></span><br><span class="line">                publishEvent(<span class="keyword">new</span> ContextClosedEvent(<span class="keyword">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 停止所有 Lifecycle bean,以避免单个地销毁期间而产生延迟。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 销毁上下文的bean工厂中所有缓存的单例对象。</span></span><br><span class="line">            destroyBeans();</span><br><span class="line">            <span class="comment">// 关闭该上下文本身的状态。</span></span><br><span class="line">            closeBeanFactory();</span><br><span class="line">            <span class="comment">// 让子类做一些最后的清理…</span></span><br><span class="line">            onClose();</span><br><span class="line">            <span class="comment">// 设置此应用上下文为非活跃状态</span></span><br><span class="line">            <span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板方法,用于销毁该上下文管理的所有bean。</span></span><br><span class="line"><span class="comment">     * 调用 DisposableBean.destroy() 或 指定的“destroy-method”销毁方法,</span></span><br><span class="line"><span class="comment">     * 默认销毁将此实现的上下文中所有缓存的单例对象。</span></span><br><span class="line"><span class="comment">      * 可以重写,以在标准单例销毁之前或之后添加上下文特定的bean销毁步骤,</span></span><br><span class="line"><span class="comment">      * 同时上下文的BeanFactory仍然处于活动状态。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getBeanFactory()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.beans.factory.config.ConfigurableBeanFactory#destroySingletons()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">destroyBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getBeanFactory().destroySingletons();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可以重写以添加特定于上下文的关闭工作的模板方法。</span></span><br><span class="line"><span class="comment">     * 默认实现为空。</span></span><br><span class="line"><span class="comment">     * 在此上下文的BeanFactory已被关闭后,调用 doClose() 方法做最后的关闭过程.</span></span><br><span class="line"><span class="comment">     * 如果在BeanFactory仍然激活状态时,需要执行自定义关闭逻辑,</span></span><br><span class="line"><span class="comment">     * 则重重写  destroyBeans() 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对于子类:默认不做任何事情。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.active.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明此上下文的BeanFactory当前是活动的,如果不是,则抛出 IllegalStateException。</span></span><br><span class="line"><span class="comment">     * 由所有依赖于活动上下文的 BeanFactory 委托方法调用,特别是所有bean访问方法。</span></span><br><span class="line"><span class="comment">     * 默认实现检查 isActive() 这个上下文的“active”状态。</span></span><br><span class="line"><span class="comment">     * 可能被覆盖用于更具体的检查,或用于如果 getBeanFactory() 本身在这种情况下抛出异常。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">assertBeanFactoryActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.active.get()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.closed.get()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(getDisplayName() + <span class="string">&quot; has been closed already&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(getDisplayName() + <span class="string">&quot; has not been refreshed yet&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// BeanFactory 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, requiredType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(name, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(requiredType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType, Object... args)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBean(requiredType, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">ObjectProvider&lt;T&gt; <span class="title">getBeanProvider</span><span class="params">(Class&lt;T&gt; requiredType)</span> </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanProvider(requiredType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">ObjectProvider&lt;T&gt; <span class="title">getBeanProvider</span><span class="params">(ResolvableType requiredType)</span> </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanProvider(requiredType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().containsBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().isSingleton(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPrototype</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().isPrototype(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String name, ResolvableType typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().isTypeMatch(name, typeToMatch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String name, Class&lt;?&gt; typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().isTypeMatch(name, typeToMatch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getType(String name) <span class="keyword">throws</span> NoSuchBeanDefinitionException &#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getType(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getAliases(String name) &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getAliases(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// ListableBeanFactory 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().containsBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBeanDefinitionCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanDefinitionCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanDefinitionNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanDefinitionNames();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanNamesForType(ResolvableType type) &#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanNamesForType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanNamesForType(<span class="meta">@Nullable</span> Class&lt;?&gt; type) &#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanNamesForType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanNamesForType(<span class="meta">@Nullable</span> Class&lt;?&gt; type, <span class="keyword">boolean</span> includeNonSingletons, <span class="keyword">boolean</span> allowEagerInit) &#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanNamesForType(type, includeNonSingletons, allowEagerInit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getBeansOfType</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;T&gt; type)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeansOfType(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getBeansOfType</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;T&gt; type, <span class="keyword">boolean</span> includeNonSingletons, <span class="keyword">boolean</span> allowEagerInit)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeansOfType(type, includeNonSingletons, allowEagerInit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getBeanNamesForAnnotation(Class&lt;? extends Annotation&gt; annotationType) &#123;</span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeanNamesForAnnotation(annotationType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getBeansWithAnnotation</span><span class="params">(Class&lt;? extends Annotation&gt; annotationType)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().getBeansWithAnnotation(annotationType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">findAnnotationOnBean</span><span class="params">(String beanName, Class&lt;A&gt; annotationType)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>&#123;</span><br><span class="line"></span><br><span class="line">        assertBeanFactoryActive();</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().findAnnotationOnBean(beanName, annotationType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// HierarchicalBeanFactory 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BeanFactory <span class="title">getParentBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getParent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsLocalBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBeanFactory().containsLocalBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果父上下文实现了ConfigurableApplicationContext接口,</span></span><br><span class="line"><span class="comment">     * 则返回父上下文的内部bean工厂；否则,返回父上下文本身。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.context.ConfigurableApplicationContext#getBeanFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BeanFactory <span class="title">getInternalParentBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (getParent() <span class="keyword">instanceof</span> ConfigurableApplicationContext ?</span><br><span class="line">                ((ConfigurableApplicationContext) getParent()).getBeanFactory() : getParent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// MessageSource 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, <span class="meta">@Nullable</span> Object[] args, <span class="meta">@Nullable</span> String defaultMessage, Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getMessageSource().getMessage(code, args, defaultMessage, locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, <span class="meta">@Nullable</span> Object[] args, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getMessageSource().getMessage(code, args, locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(MessageSourceResolvable resolvable, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getMessageSource().getMessage(resolvable, locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回上下文使用的内部 MessageSource。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 此上下文内部的 MessageSource (非 null&#125;)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException 如果上下文尚未初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MessageSource <span class="title">getMessageSource</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.messageSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;MessageSource not initialized - &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;call &#x27;refresh&#x27; before accessing messages via the context: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.messageSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果父上下文也是AbstractApplicationContext抽象类,则返回父上下文的内部 MessageSource；</span></span><br><span class="line"><span class="comment">      * 否则,返回父上下文本身。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> MessageSource <span class="title">getInternalParentMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (getParent() <span class="keyword">instanceof</span> AbstractApplicationContext ?</span><br><span class="line">            ((AbstractApplicationContext) getParent()).messageSource : getParent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// ResourcePatternResolver 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.resourcePatternResolver.getResources(locationPattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// Lifecycle 接口的实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getLifecycleProcessor().start();</span><br><span class="line">        publishEvent(<span class="keyword">new</span> ContextStartedEvent(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getLifecycleProcessor().stop();</span><br><span class="line">        publishEvent(<span class="keyword">new</span> ContextStoppedEvent(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.lifecycleProcessor.isRunning());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 必须由子类实现的抽象方法</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 子类必须实现此方法来执行实际配置的加载。</span></span><br><span class="line"><span class="comment">     * 在任何其他初始化工作之前,可通过 refresh() 调用此方法。</span></span><br><span class="line"><span class="comment">     * 子类要么创建一个新的bean工厂并持有对它的引用,</span></span><br><span class="line"><span class="comment">     * 要么返回一个它持有的BeanFactory实例。</span></span><br><span class="line"><span class="comment">     * 在后一种情况下,如果多次刷新上下文,它通常会抛出一个IllegalStateException。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException 如果bean工厂的初始化失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException 如果已经初始化并且不支持多次刷新尝试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 子类必须实现此方法来释放它们内部bean工厂。</span></span><br><span class="line"><span class="comment">     * 在所有其他关闭工作之后, close() 将调用此方法。</span></span><br><span class="line"><span class="comment">     * 永远不要抛出异常,而是日志关闭失败。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">closeBeanFactory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 子类必须在这里返回其内部bean工厂。</span></span><br><span class="line"><span class="comment">     * 它们应该有效地实现查找,这样就可以重复调用查找,而不会影响性能。</span></span><br><span class="line"><span class="comment">     * 注意:在返回内部bean工厂之前,子类应该检查上下文是否仍然是活动的。</span></span><br><span class="line"><span class="comment">     * 一旦上下文关闭,内部工厂通常被认为不可用。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 此应用上下文的内部bean工厂(非null)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException 如果上下文还没有包含内部bean工厂(通常是 refresh()&#125;从未被调用),或者上下文已经被关闭</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #refreshBeanFactory()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #closeBeanFactory()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 返回关于此上下文的信息。 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(getDisplayName());</span><br><span class="line">        sb.append(<span class="string">&quot;, started on &quot;</span>).append(<span class="keyword">new</span> Date(getStartupDate()));</span><br><span class="line">        ApplicationContext parent = getParent();</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;, parent: &quot;</span>).append(parent.getDisplayName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="getBeansWithAnnotation方法实例："><a href="#getBeansWithAnnotation方法实例：" class="headerlink" title="getBeansWithAnnotation方法实例："></a>getBeansWithAnnotation方法实例：</h2><p>XXLJOB实际使用注解使用@JobHandler标识是一个job handler,当XXLJOB在执行AOP方法时,扫描注解执行handle方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123; </span><br><span class="line">        MDC.put(RequestUtil.REQUEST_TRACEID, RequestUtil.getRequestId());</span><br><span class="line">        Object result= joinPoint.proceed();</span><br><span class="line">        MDC.clear();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>再执行Executor加载jobhandler时执行IJobHandler newJobHandler = XxlJobExecutor.loadJobHandler(triggerParam.getExecutorHandler());调佣start方法初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init JobHandler Repository</span></span><br><span class="line">        initJobHandlerRepository(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// refresh GlueFactory</span></span><br><span class="line">        GlueFactory.refreshInstance(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// super start</span></span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initJobHandlerRepository</span><span class="params">(ApplicationContext applicationContext)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init job handler action</span></span><br><span class="line">        Map&lt;String, Object&gt; serviceBeanMap = applicationContext.getBeansWithAnnotation(JobHandler.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (serviceBeanMap!=<span class="keyword">null</span> &amp;&amp; serviceBeanMap.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Object serviceBean : serviceBeanMap.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (serviceBean <span class="keyword">instanceof</span> IJobHandler)&#123;</span><br><span class="line">                    String name = serviceBean.getClass().getAnnotation(JobHandler.class).value();</span><br><span class="line">                    IJobHandler handler = (IJobHandler) serviceBean;</span><br><span class="line">                    <span class="keyword">if</span> (loadJobHandler(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job jobhandler naming conflicts.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    registJobHandler(name, handler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">初始化动作</span><br><span class="line"> <span class="comment">// init job handler action</span></span><br><span class="line">Map&lt;String, Object&gt; serviceBeanMap = applicationContext.getBeansWithAnnotation(JobHandler.class);</span><br></pre></td></tr></table></figure>

<h2 id="AnnotationConfigWebApplicationContext"><a href="#AnnotationConfigWebApplicationContext" class="headerlink" title="AnnotationConfigWebApplicationContext"></a>AnnotationConfigWebApplicationContext</h2><p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/AnnotationConfigWebApplicationContext.jpg" alt="流程"><br>AnnotationConfigWebApplicationContext–&gt;WebApplicationContext–&gt;ApplicationContext<br>核心方法：loadBeanDefinitions</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) &#123;</span><br><span class="line">    //加载Bean</span><br><span class="line">    AnnotatedBeanDefinitionReader reader = getAnnotatedBeanDefinitionReader(beanFactory);</span><br><span class="line">    //扫描注解</span><br><span class="line">    ClassPathBeanDefinitionScanner scanner = getClassPathBeanDefinitionScanner(beanFactory);</span><br><span class="line">    //装配Bean</span><br><span class="line">    BeanNameGenerator beanNameGenerator = getBeanNameGenerator();</span><br><span class="line">    if (beanNameGenerator != null) &#123;</span><br><span class="line">        reader.setBeanNameGenerator(beanNameGenerator);</span><br><span class="line">        scanner.setBeanNameGenerator(beanNameGenerator);</span><br><span class="line">        //注册Bean</span><br><span class="line">        beanFactory.registerSingleton(AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR, beanNameGenerator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ScopeMetadataResolver scopeMetadataResolver = getScopeMetadataResolver();</span><br><span class="line">    if (scopeMetadataResolver != null) &#123;</span><br><span class="line">        reader.setScopeMetadataResolver(scopeMetadataResolver);</span><br><span class="line">        scanner.setScopeMetadataResolver(scopeMetadataResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.annotatedClasses.isEmpty()) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Registering annotated classes: [&quot; +</span><br><span class="line">                    StringUtils.collectionToCommaDelimitedString(this.annotatedClasses) + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //注册Bean</span><br><span class="line">        reader.register(ClassUtils.toClassArray(this.annotatedClasses));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.basePackages.isEmpty()) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Scanning base packages: [&quot; +</span><br><span class="line">                    StringUtils.collectionToCommaDelimitedString(this.basePackages) + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //扫描指定基包</span><br><span class="line">        scanner.scan(StringUtils.toStringArray(this.basePackages));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] configLocations = getConfigLocations();</span><br><span class="line">    if (configLocations != null) &#123;</span><br><span class="line">        for (String configLocation : configLocations) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Class&lt;?&gt; clazz = ClassUtils.forName(configLocation, getClassLoader());</span><br><span class="line">                if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                    logger.trace(&quot;Registering [&quot; + configLocation + &quot;]&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                reader.register(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (ClassNotFoundException ex) &#123;</span><br><span class="line">                if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                    logger.trace(&quot;Could not load class for config location [&quot; + configLocation +</span><br><span class="line">                            &quot;] - trying package scan. &quot; + ex);</span><br><span class="line">                &#125;</span><br><span class="line">                int count = scanner.scan(configLocation);</span><br><span class="line">                if (count == 0 &amp;&amp; logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;No annotated classes found for specified class/package [&quot; + configLocation + &quot;]&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BeanPostProcessor-后置处理器"><a href="#BeanPostProcessor-后置处理器" class="headerlink" title="BeanPostProcessor(后置处理器)"></a>BeanPostProcessor(后置处理器)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的context中随处可见对BeanPostProcessor的方法调用,用于检查标记接口或用代理封装,在Bean对象在实例化和依赖注入完毕后调用,第三方扩展功能均会实现此接口,在Bean的初始化时,通过InitializingBean来调用afterPropertiesSet方法。</p>
<h2 id="ApplicationContextAware"><a href="#ApplicationContextAware" class="headerlink" title="ApplicationContextAware"></a>ApplicationContextAware</h2><p>在某些特殊的情况下,Bean需要实现某个功能,但该功能必须借助于Spring容器才能实现,此时就必须让该Bean先获取Spring容器,然后借助于Spring容器实现该功能。为了让Bean获取它所在的Spring容器,可以让该Bean实现ApplicationContextAware接口。ApplicationContextAware 通过它Spring容器会自动把上下文环境对象调用ApplicationContextAware接口中的setApplicationContext方法。在ApplicationContextAware的实现类中,就可以通过这个上下文环境对象得到Spring容器中的Bean。看到—Aware就知道是干什么的了,就是属性注入的,但是这个ApplicationContextAware的不同地方在于,实现了这个接口的bean,当spring容器初始化的时候,会自动的将ApplicationContext注入进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContextAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置此对象在其中运行的ApplicationContext。通常,此调用将用于初始化对象。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">//setContext</span></span><br><span class="line">        applicationContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getApplicationContext().getBean(requiredType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) getApplicationContext().getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ResourceLoaderAware"><a href="#ResourceLoaderAware" class="headerlink" title="ResourceLoaderAware"></a>ResourceLoaderAware</h2><p>ResourceLoaderAware是特殊的标记接口，它希望拥有一个ResourceLoader 引用的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当实现了 ResourceLoaderAware接口的类部署到application context(比如受Spring管理的bean)中时，它会被application context识别为 ResourceLoaderAware。 接着application context会调用setResourceLoader(ResourceLoader)方法，并把自身作为参数传入该方法(记住，所有Spring里的application context都实现了ResourceLoader接口)。</p>
<p>既然 ApplicationContext 就是ResourceLoader，那么该bean就可以实现 ApplicationContextAware接口并直接使用所提供的application context来载入资源，但是通常更适合使用特定的满足所有需要的 ResourceLoader实现。 这样一来，代码只需要依赖于可以看作辅助接口的资源载入接口，而不用依赖于整个Spring ApplicationContext 接口。</p>
<p>从Spring 2.5开始, 你可以使用ResourceLoader 的自动装配来代替实现 ResourceLoaderAware 接口。“传统的” constructor及 byType的自动装配模式 (第 3.3.5 节 “自动装配（autowire）协作者”已有论述)现在可以分别为构造方法参数及setter方法参数提供 ResourceLoader 类型的依赖。请使用新式的基于注解的自动装配特性以提供更大的灵活性（包括装配属性及多个方法参数的能力）。在这种情况下，只要属性、构造方法或者方法被 @Autowired注解修饰，ResourceLoader 就会被装配到需要ResourceLoader类型的属性、构造方法参数或者方法参数中</p>
<h3 id="Servlet与HttpServlet"><a href="#Servlet与HttpServlet" class="headerlink" title="Servlet与HttpServlet"></a>Servlet与HttpServlet</h3><p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="流程"><br>类图标明很是明显,在这个图中展示了servlet,tomcat,Springboot的关系,完美解释了那句Springboot是内嵌了tomcat的嵌入式引擎,嵌入式容器的说法~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">而HttpServlet即是大部分请求的处理对象,嵌入式引擎----&gt;嵌入式容器----&gt;webfilter----&gt;weblistener</span><br><span class="line">javax.servlet.ServletContext#addServlet(java.lang.String, java.lang.Class&lt;? extends javax.servlet.Servlet&gt;)返回一个ServletRegistration对象,可用于进一步</span><br><span class="line">配置已注册的servlet</span><br><span class="line">javax.servlet.ServletRegistration</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletRegistration</span> <span class="keyword">extends</span> <span class="title">Registration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urlPatterns The URL patterns that this Servlet should be mapped to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if urlPattern is null or empty</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if the associated ServletContext has</span></span><br><span class="line"><span class="comment">     *                                  already been initialised</span></span><br><span class="line"><span class="comment">     */</span>URL必须映射</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addMapping</span><span class="params">(String... urlPatterns)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getMappings</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRunAsRole</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dynamic</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">ServletRegistration</span>, <span class="title">Registration</span>.<span class="title">Dynamic</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoadOnStartup</span><span class="params">(<span class="keyword">int</span> loadOnStartup)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">setServletSecurity</span><span class="params">(ServletSecurityElement constraint)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMultipartConfig</span><span class="params">(MultipartConfigElement multipartConfig)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRunAsRole</span><span class="params">(String roleName)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>思考：为什么Applacationcontext会有那么多重载方法？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> ServletRegistration.<span class="function">Dynamic <span class="title">addServlet</span><span class="params">(String servletName, String className)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> addServlet(servletName, className, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> ServletRegistration.<span class="function">Dynamic <span class="title">addServlet</span><span class="params">(String servletName, Servlet servlet)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> addServlet(servletName, <span class="keyword">null</span>, servlet, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> ServletRegistration.<span class="function">Dynamic <span class="title">addServlet</span><span class="params">(String servletName,</span></span></span><br><span class="line"><span class="params"><span class="function">           Class&lt;? extends Servlet&gt; servletClass)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> addServlet(servletName, servletClass.getName(), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>–用在不同场景下解决同一类问题<br>而在HttpServlet中的关键方法service可看到平时请求接口的所有方法<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/servlet-service.png" alt="流程"><br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/service-post.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_DELETE = <span class="string">&quot;DELETE&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_HEAD = <span class="string">&quot;HEAD&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_GET = <span class="string">&quot;GET&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_OPTIONS = <span class="string">&quot;OPTIONS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_POST = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_PUT = <span class="string">&quot;PUT&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_TRACE = <span class="string">&quot;TRACE&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String method = req.getMethod();</span><br><span class="line">        <span class="comment">//GET</span></span><br><span class="line">        <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class="line">            <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">            <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// servlet doesn&#x27;t support if-modified-since, no reason</span></span><br><span class="line">                <span class="comment">// to go through further expensive logic</span></span><br><span class="line">                doGet(req, resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class="line">                <span class="keyword">if</span> (ifModifiedSince &lt; lastModified) &#123;</span><br><span class="line">                    <span class="comment">// If the servlet mod time is later, call doGet()</span></span><br><span class="line">                    <span class="comment">// Round down to the nearest second for a proper compare</span></span><br><span class="line">                    <span class="comment">// A ifModifiedSince of -1 will always be less</span></span><br><span class="line">                    maybeSetLastModified(resp, lastModified);</span><br><span class="line">                    doGet(req, resp);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class="line">            <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">            maybeSetLastModified(resp, lastModified);</span><br><span class="line">            doHead(req, resp);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class="line">            doPost(req, resp);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class="line">            doPut(req, resp);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class="line">            doDelete(req, resp);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class="line">            doOptions(req,resp);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class="line">            doTrace(req,resp);</span><br><span class="line">            <span class="comment">//There&#x27;s no need to override this method. 没有必要~</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Note that this means NO servlet supports whatever</span></span><br><span class="line">            <span class="comment">// method was requested, anywhere on this server.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            String errMsg = lStrings.getString(<span class="string">&quot;http.method_not_implemented&quot;</span>);</span><br><span class="line">            Object[] errArgs = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">            errArgs[<span class="number">0</span>] = method;</span><br><span class="line">            errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class="line">            </span><br><span class="line">            resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    String protocol = req.getProtocol();</span><br><span class="line">    String msg = lStrings.getString(<span class="string">&quot;http.method_post_not_supported&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (protocol.endsWith(<span class="string">&quot;1.1&quot;</span>)) &#123;</span><br><span class="line">        resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：在javaHttpServlet中,与Tomcat中的dopost方法如出一辙</p>
<p>真正的调用链(妥妥的责任链模式)是<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/HTTP%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.jpg" alt="流程"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Tomcat与SpringMVC的结合点：</span><br><span class="line">（1）所有配置了路由信息的处理方法最终都是通过反射的方式进行调用的；</span><br><span class="line">（2）在Java8中,反射方法调用最终落脚于NativeMethodAccessorImpl类的native方法：</span><br><span class="line">private static native Object invoke0(Method var0, Object var1, Object[] var2);</span><br><span class="line">在此处与JVM底层交互,实现跨代码衔接执行；</span><br><span class="line">（3）观察到的比较重要的设计模式：职责链模式（ApplicationFilterChain）、委派模式（DelegatingFilterProxy）、</span><br><span class="line">工厂模式、策略模式、代理模式（FilterChainProxy）、外观模式、适配器模式（HandlerAdapter）；</span><br><span class="line">（4）Tomcat与SpringMVC的结合点：ApplicationFilterChain与DispatcherServlet（继承于FrameworkServlet）；</span><br><span class="line">（5）在集成了Tomcat的SpringBoot项目中,先启动的不是Tomcat,而是Spring,Spring的工厂（默认DefaultListableBeanFactory）</span><br><span class="line">读取注解完成各类Bean（WebApplicationContext、securityFilterChainRegistration、dispatcherServletRegistration、各类FilterInitializer与Filter）</span><br><span class="line">的初始化,放入IoC容器,然后做路由Mapping,创建FilterChain,开启JMX等；</span><br><span class="line">（6）Servlet、Filter是单实例多线程的,成员变量线程不安全,方法内局部变量线程安全；SingleThreadModel采用同步/实例池的方式来确保不会有两个线程同时执行servlet的service方法,但已被弃用,需自行确保成员变量线程安全；</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「wanxu12345678910」的原创文章,遵循CC 4.0 BY-SA版权协议,转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/wanxu12345678910/article/details/83352371</span><br></pre></td></tr></table></figure>

<p>ContextLoaderServlet与下文中的ContextLoaderListener功能完全相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">         &lt;servlet-name&gt;context&lt;/servlet-name&gt;</span><br><span class="line">         &lt;servlet-<span class="class"><span class="keyword">class</span>&gt;</span></span><br><span class="line"><span class="class">           <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">web</span>.<span class="title">context</span>.<span class="title">ContextLoaderServlet</span></span></span><br><span class="line"><span class="class">         &lt;/<span class="title">servlet</span>-<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">         &lt;<span class="title">load</span>-<span class="title">on</span>-<span class="title">startup</span>&gt;1&lt;/<span class="title">load</span>-<span class="title">on</span>-<span class="title">startup</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">servlet</span>&gt; </span></span><br></pre></td></tr></table></figure>

<h3 id="HttpServletResponse响应码"><a href="#HttpServletResponse响应码" class="headerlink" title="HttpServletResponse响应码"></a>HttpServletResponse响应码</h3><p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/statusCode.png" alt="流程"></p>
<h4 id="监听器：-实现接口、标记"><a href="#监听器：-实现接口、标记" class="headerlink" title="监听器：   实现接口、标记"></a>监听器：   实现接口、标记</h4><p>比如MQ,观察者模式,所有的时间监听都会继承  extend   java.util.EventListener接口,但里面什么都没有<br>,称之为mark接口,经典实现：ContextLoaderListener、RequestContextListener(重要)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A tagging interface that all event listener interfaces must extend.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/listener.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bootstrap listener to start up and shut down Spring&#x27;s root &#123;<span class="doctag">@link</span> WebApplicationContext&#125;.</span></span><br><span class="line"><span class="comment"> * Simply delegates to &#123;<span class="doctag">@link</span> ContextLoader&#125; as well as to &#123;<span class="doctag">@link</span> ContextCleanupListener&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As of Spring 3.1, &#123;<span class="doctag">@code</span> ContextLoaderListener&#125; supports injecting the root web</span></span><br><span class="line"><span class="comment"> * application context via the &#123;<span class="doctag">@link</span> #ContextLoaderListener(WebApplicationContext)&#125;</span></span><br><span class="line"><span class="comment"> * constructor, allowing for programmatic configuration in Servlet 3.0+ environments.</span></span><br><span class="line"><span class="comment"> * See &#123;<span class="doctag">@link</span> org.springframework.web.WebApplicationInitializer&#125; for usage examples.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 17.02.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setContextInitializers</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.WebApplicationInitializer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextLoaderListener</span> <span class="keyword">extends</span> <span class="title">ContextLoader</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>见名知意既然包含contextLoader必然跟上线文息息相关,在初始化容器时加载配置~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent requestEvent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(requestEvent.getServletRequest() <span class="keyword">instanceof</span> HttpServletRequest)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;Request is not an HttpServletRequest: &quot;</span> + requestEvent.getServletRequest());</span><br><span class="line">        &#125;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) requestEvent.getServletRequest();</span><br><span class="line">        ServletRequestAttributes attributes = <span class="keyword">new</span> ServletRequestAttributes(request);</span><br><span class="line">        request.setAttribute(REQUEST_ATTRIBUTES_ATTRIBUTE, attributes);</span><br><span class="line">        <span class="comment">//将请求对象放入ThreadLocal中</span></span><br><span class="line">        LocaleContextHolder.setLocale(request.getLocale());</span><br><span class="line">        RequestContextHolder.setRequestAttributes(attributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><font color="red"> 重要：Servlet在同一个线程中,当初始化时放到对象里,当请求销毁时,自动将Threadlocal对象销毁,防止了内存泄漏的问题 </font><br>当有请求到达时,会从线程池中取出一个线程来执行任务,执行完毕后再将线程回收至线程池,这样当前请求不可能拿到上一个请求保存在ThreadLocal对象里的值<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/Threadlocal.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent requestEvent)</span> </span>&#123;</span><br><span class="line">        ServletRequestAttributes attributes = <span class="keyword">null</span>;</span><br><span class="line">        Object reqAttr = requestEvent.getServletRequest().getAttribute(REQUEST_ATTRIBUTES_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (reqAttr <span class="keyword">instanceof</span> ServletRequestAttributes) &#123;</span><br><span class="line">            attributes = (ServletRequestAttributes) reqAttr;</span><br><span class="line">        &#125;</span><br><span class="line">        RequestAttributes threadAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">if</span> (threadAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We&#x27;re assumably within the original request thread...</span></span><br><span class="line">            LocaleContextHolder.resetLocaleContext();</span><br><span class="line">            RequestContextHolder.resetRequestAttributes();</span><br><span class="line">            <span class="keyword">if</span> (attributes == <span class="keyword">null</span> &amp;&amp; threadAttributes <span class="keyword">instanceof</span> ServletRequestAttributes) &#123;</span><br><span class="line">                attributes = (ServletRequestAttributes) threadAttributes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            attributes.requestCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/ThreadLocalremove.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bootstrap listener to start up and shut down Spring&#x27;s root &#123;<span class="doctag">@link</span> WebApplicationContext&#125;.</span></span><br><span class="line"><span class="comment"> * Simply delegates to &#123;<span class="doctag">@link</span> ContextLoader&#125; as well as to &#123;<span class="doctag">@link</span> ContextCleanupListener&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As of Spring 3.1, &#123;<span class="doctag">@code</span> ContextLoaderListener&#125; supports injecting the root web</span></span><br><span class="line"><span class="comment"> * application context via the &#123;<span class="doctag">@link</span> #ContextLoaderListener(WebApplicationContext)&#125;</span></span><br><span class="line"><span class="comment"> * constructor, allowing for programmatic configuration in Servlet 3.0+ environments.</span></span><br><span class="line"><span class="comment"> * See &#123;<span class="doctag">@link</span> org.springframework.web.WebApplicationInitializer&#125; for usage examples.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 17.02.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setContextInitializers</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.WebApplicationInitializer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextLoaderListener</span> <span class="keyword">extends</span> <span class="title">ContextLoader</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插播一句：在书写过程中发现某URL响应变慢,在分析SQL时,用到了in查询,执行分析计划用到了索引</p>
<h1 id="Servlet-on-Springboot"><a href="#Servlet-on-Springboot" class="headerlink" title="Servlet on Springboot"></a>Servlet on Springboot</h1><h3 id="组件扫描：ServletComponentScan"><a href="#组件扫描：ServletComponentScan" class="headerlink" title="组件扫描：ServletComponentScan"></a>组件扫描：ServletComponentScan</h3><p>熟悉波~ 是不是应用跟Springboot的@ComponentScan如出一辙</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(ServletComponentScanRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ServletComponentScan &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span></span><br><span class="line"><span class="comment">     * declarations e.g.: &#123;<span class="doctag">@code</span> <span class="doctag">@ServletComponentScan</span>(&quot;org.my.pkg&quot;)&#125; instead of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> <span class="doctag">@ServletComponentScan</span>(basePackages=&quot;org.my.pkg&quot;)&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;basePackages&quot;)</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base packages to scan for annotated servlet components. &#123;<span class="doctag">@link</span> #value()&#125; is an</span></span><br><span class="line"><span class="comment">     * alias for (and mutually exclusive with) this attribute.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based</span></span><br><span class="line"><span class="comment">     * package names.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to</span></span><br><span class="line"><span class="comment">     * scan for annotated servlet components. The package of each class specified will be</span></span><br><span class="line"><span class="comment">     * scanned.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> classes from the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>配置声明：@interface  暴露SpringBean @Bean<br>事件：Event</p>
<h4 id="filter："><a href="#filter：" class="headerlink" title="filter："></a>filter：</h4><p>webFilter<br>OncePerRequestFilter：只调用一次且是线程安全的<br>而其子类得ApplicationContextHeaderFilter调用的dofilter方法就是我们上面提到的真正在请求中执行的filter</p>
<h3 id="激活Springbootweb"><a href="#激活Springbootweb" class="headerlink" title="激活Springbootweb"></a>激活Springbootweb</h3><p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/oncePerRequestFilter.png" alt="流程"></p>
<p>文无第一,武无第二,没有最好的技术框架或体系,只有最适合当下业务的框架或体系<br>谈谈你对技术的理解：天上飞的理念,必定有落地的实现</p>
<h3 id="组装SpringApplicationBuilder"><a href="#组装SpringApplicationBuilder" class="headerlink" title="组装SpringApplicationBuilder"></a>组装SpringApplicationBuilder</h3><p>你看看这名字就知道他以后干啥的,并且它包含了太多太多的东西,<br>SpringApplication和ApplicationContext实例的生成器,基本包含了所有的SpringbootApplacation特性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableApplicationContext context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SpringApplicationBuilder parent;</span><br><span class="line">AtomicBoolean是不是的看看</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean running = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; sources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; defaultProperties = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; additionalProfiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registerShutdownHookApplied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> configuredAsChild = <span class="keyword">false</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProfiles</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">new</span> SpringApplicationBuilder(TestProfiles.class)</span><br><span class="line">                .properties(<span class="string">&quot;spring.config.location=classpath:/test-profiles.yml&quot;</span>)</span><br><span class="line">                .properties(<span class="string">&quot;spring.profiles.active=oracle&quot;</span>)</span><br><span class="line">                .run(args);</span><br><span class="line">        <span class="comment">// 输出变量</span></span><br><span class="line">        System.out.println(context.getEnvironment().getProperty(<span class="string">&quot;jdbc.driver&quot;</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 启动第二个Spring容器,指定端口为8848</span></span><br><span class="line">        ConfigurableApplicationContext context2 = <span class="keyword">new</span> SpringApplicationBuilder(TestProfiles.class)</span><br><span class="line">                .properties(<span class="string">&quot;spring.config.location=classpath:/test-profiles.yml&quot;</span>)</span><br><span class="line">                .properties(<span class="string">&quot;spring.profiles.active=mysql&quot;</span>)</span><br><span class="line">                .properties(<span class="string">&quot;server.port=8848&quot;</span>)</span><br><span class="line">                .run(args);</span><br><span class="line">        <span class="comment">// 输出变量</span></span><br><span class="line">        System.out.println(context2.getEnvironment().getProperty(<span class="string">&quot;jdbc.driver&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Springboot自动装配<br>/META-INF/spring.factories<br>XXXAotuConfigration<br>NIO不是异步IO而是非阻塞IO<br>java9推崇模块化</p>
<p>ClassLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(contextClassLoader.getClass().getName());</span><br><span class="line">        ClassLoader parent = contextClassLoader.getParent();</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    System.out.println(systemClassLoader.getClass().getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>update_time =2022年2月14日13:48:19</p>
<h2 id="传统的Servlet容器-Apache-Tomcat"><a href="#传统的Servlet容器-Apache-Tomcat" class="headerlink" title="传统的Servlet容器 Apache Tomcat"></a>传统的Servlet容器 Apache Tomcat</h2><p>这里只记录了部分重要场景<br>包含核心组件<br>静态资源处理<br>类加载<br>连接器<br>JDBC数据源</p>
<h2 id="HttpServletResponse"><a href="#HttpServletResponse" class="headerlink" title="HttpServletResponse"></a>HttpServletResponse</h2><p>javax.servlet.http.HttpServletResponse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(contextClassLoader.getClass().getName());</span><br><span class="line">        ClassLoader parent = contextClassLoader.getParent();</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    System.out.println(systemClassLoader.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了其中的状态码之外,结合最近的测试其中的实现可具体参考<br>addHeader方法,getHeader方法等等<br>BootStrap–system—common—webapp</p>
<h2 id="静态资源处理类org-apache-catalina-servlets-DefaultServlet"><a href="#静态资源处理类org-apache-catalina-servlets-DefaultServlet" class="headerlink" title="静态资源处理类org.apache.catalina.servlets.DefaultServlet"></a>静态资源处理类org.apache.catalina.servlets.DefaultServlet</h2><p>注意下包名</p>
<p>大多数情况下我们关注的更多是server.xml中Tomcat的配置,而在web.xml中除了路径映射等配置外</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- The mapping <span class="keyword">for</span> the <span class="keyword">default</span> servlet --&gt;</span><br><span class="line">   &lt;servlet-mapping&gt;</span><br><span class="line">       &lt;servlet-name&gt;<span class="keyword">default</span>&lt;/servlet-name&gt;</span><br><span class="line">       &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">   &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- The mappings <span class="keyword">for</span> the JSP servlet --&gt;</span><br><span class="line">   &lt;servlet-mapping&gt;</span><br><span class="line">       &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;</span><br><span class="line">       &lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;</span><br><span class="line">       &lt;url-pattern&gt;*.jspx&lt;/url-pattern&gt;</span><br><span class="line">   &lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>关于是否是开发模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--   development         Is Jasper used in development mode? If <span class="keyword">true</span>,   --&gt;</span><br><span class="line"> &lt;!--                       the frequency at which JSPs are checked <span class="keyword">for</span>    --&gt;</span><br><span class="line"> &lt;!--                       modification may be specified via the          --&gt;</span><br><span class="line"> &lt;!--                       modificationTestInterval parameter. [<span class="keyword">true</span>]     --&gt;</span><br></pre></td></tr></table></figure>
<p>由于DefaultServlet是HttpServlet的子类,所以在此不展开讨论<br>而在server.xml中标签与后台接口是一一绑定的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connectionTimeout=<span class="string">&quot;20000&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>而在JDBC中的大多数类中也遵循此规则,那么就上面这段分析标签Connector则对应<br>org.apache.catalina.connector.Connector,验证一下标签中对应protocol,connectionTimeout,redirectPort<br>其中标签对应部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Defaults to using HTTP/1.1 NIO implementation.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>而在tomcat8.0+中getProtocol对应protocol<br>redirectPort对应属性默认值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The redirect port for non-SSL to SSL redirects.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> redirectPort = <span class="number">443</span>;</span><br></pre></td></tr></table></figure>
<p>关于标签中connector中这个Http11NioProtocol则在tomcat官方文档中可见其中一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When using HTTP connectors (based on APR or NIO/NIO2), Tomcat supports using sendfile to send large static files. These writes, as soon as the system load increases, will be performed asynchronously in the most efficient way. Instead of sending a large response using blocking writes, it is possible to write content to a static file, and write it using a sendfile code. A caching valve could take advantage of this to cache the response data in a file rather than store it in memory. Sendfile support is available if the request attribute org.apache.tomcat.sendfile.support is set to Boolean.TRUE</span><br></pre></td></tr></table></figure>
<p>也可在server.xml中搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector protocol=&quot;AJP/1.3&quot;</span><br><span class="line">               address=&quot;::1&quot;</span><br><span class="line">               port=&quot;8009&quot;</span><br><span class="line">               redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">    --&gt;</span><br></pre></td></tr></table></figure>
<p>server.port在文件中的位置</p>
<!-- {
      "name": "server.port",
      "type": "java.lang.Integer",
      "description": "Server HTTP port.",
      "sourceType": "org.springframework.boot.autoconfigure.web.ServerProperties",
      "defaultValue": 8080
    }, -->
<h2 id="重点来了-ServerProperties包含了tomcat-Jetty-Undertow-而在Springboot2-2-6中则存在Netty"><a href="#重点来了-ServerProperties包含了tomcat-Jetty-Undertow-而在Springboot2-2-6中则存在Netty" class="headerlink" title="重点来了 ServerProperties包含了tomcat,Jetty,Undertow,而在Springboot2.2.6中则存在Netty"></a>重点来了 ServerProperties包含了tomcat,Jetty,Undertow,而在Springboot2.2.6中则存在Netty</h2><p>那么理所当然,在tomcat中的一些配置也存在于此</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maximum amount of worker threads.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxThreads = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Minimum amount of worker threads.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> minSpareThreads = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h2 id="那么为什么Tomcat被称之为嵌入式容器呢？"><a href="#那么为什么Tomcat被称之为嵌入式容器呢？" class="headerlink" title="那么为什么Tomcat被称之为嵌入式容器呢？"></a>那么为什么Tomcat被称之为嵌入式容器呢？</h2><p>在启动时无需自启动容器,在Bootstrap中调用tomcat,另外tomcat中TomcatEmbeddedContext,Embedded即直译为嵌入式<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/embedded.png" alt="流程"><br>这里记忆有些混乱了,有点找不过来哪里是入口了,但先从TomcatServletWebServerFactoryCustomizer的customize()方法调用找,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Stream&lt;Wrapper&gt; <span class="title">getLoadOnStartupWrappers</span><span class="params">(Container[] children)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer, List&lt;Wrapper&gt;&gt; grouped = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">            Wrapper wrapper = (Wrapper) child;</span><br><span class="line">            <span class="keyword">int</span> order = wrapper.getLoadOnStartup();</span><br><span class="line">            <span class="keyword">if</span> (order &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                grouped.computeIfAbsent(order, ArrayList::<span class="keyword">new</span>);</span><br><span class="line">                grouped.get(order).add(wrapper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> grouped.values().stream().flatMap(List::stream);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为要看下Netty,所以还是重新看下server.properties<br>我将Spring Boot AutoConfigure升级到了2.6.2,内置的Tomcat就升级到9.0了<br>为了方便查看才升级的,之前的2.1.x就不截图了<br>server.properties的位置在configuration的下面的json文件<br>spring-configuration-metadata.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      &quot;name&quot;: &quot;server&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;org.springframework.boot.autoconfigure.web.ServerProperties&quot;,</span><br><span class="line">      &quot;sourceType&quot;: &quot;org.springframework.boot.autoconfigure.web.ServerProperties&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那既然为了看Netty在这个json文件中同样存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      &quot;name&quot;: &quot;server.netty&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;org.springframework.boot.autoconfigure.web.ServerProperties$Netty&quot;,</span><br><span class="line">      &quot;sourceType&quot;: &quot;org.springframework.boot.autoconfigure.web.ServerProperties&quot;,</span><br><span class="line">      &quot;sourceMethod&quot;: &quot;getNetty()&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然在json中存在getNetty等方法,猜测那么对应的ServerProperties也存在对应的方法,<br>因为存在实例么,tomcat搭配server.xml和web.xml简单看了一下,当然Tomcat还是主要和Servlet的关联关系更为重要,<br>本身tomcat知识点也最够庞大的,包含类加载器,双拼委派,打破双亲委派、jvm调优等等,可以顺带看下这里的专题</p>
<h2 id="当一次请求发起都发生了什么？"><a href="#当一次请求发起都发生了什么？" class="headerlink" title="当一次请求发起都发生了什么？"></a>当一次请求发起都发生了什么？</h2><p>用户通过浏览器进行了一个操作,这个操作可以是输入url地址并回车,或者是点击超链接,或者是在搜索框中输入关键字进行搜索,接着浏览器就捕获到了这个事件<br>由于 HTTP 协议底层具体的数据传输使用的是 TCP/IP 协议,因此浏览器需要向服务端发出 TCP 连接请求<br>服务器接受浏览器的连接请求,并经过 TCP 三次握手建立连接<br>浏览器将请求数据打包成一个 HTTP 协议格式的数据包<br>浏览器将打包好的数据包推入网络,经过网络传输最终到达服务器指定程序<br>服务端程序拿到数据包后,根据 HTTP 协议格式进行解包,获取到客户端的意图<br>得知客户端意图后进行处理,比如提供静态文件或者调用服务端程序获得动态结果<br>服务器将响应结果按照 HTTP 协议格式打包<br>服务器将响应数据包推入网络,数据包经过网络传输最终达到到浏览器<br>浏览器拿到数据包后,按照 HTTP 协议的格式解包,然后对数据进行解析<br>浏览器将解析后的静态数据（如html、图片）展示给用户</p>
<p>Tomcat 作为一个 HTTP 服务器,主要需要完成的功能是接受连接、解析请求数据、处理请求和发送响应这几个步骤。<br>作者：若兮缘<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7c9401b85704">https://www.jianshu.com/p/7c9401b85704</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权,非商业转载请注明出处。<br>关于tomcat的架构就取自这篇文章,图文都很喜欢~</p>
<p>导入过程Running With JRE 7 Or Later</p>
<p>启动tomcat所需环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">   eval $_NOHUP <span class="string">&quot;\&quot;$_RUNJAVA\&quot;&quot;</span> <span class="string">&quot;\&quot;$CATALINA_LOGGING_CONFIG\&quot;&quot;</span> $LOGGING_MANAGER <span class="string">&quot;$JAVA_OPTS&quot;</span> <span class="string">&quot;$CATALINA_OPTS&quot;</span> \</span><br><span class="line">     -D$ENDORSED_PROP=<span class="string">&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot;</span> \</span><br><span class="line">     -classpath <span class="string">&quot;\&quot;$CLASSPATH\&quot;&quot;</span> \</span><br><span class="line">     -Dcatalina.base=<span class="string">&quot;\&quot;$CATALINA_BASE\&quot;&quot;</span> \</span><br><span class="line">     -Dcatalina.home=<span class="string">&quot;\&quot;$CATALINA_HOME\&quot;&quot;</span> \</span><br><span class="line">     -Djava.io.tmpdir=<span class="string">&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot;</span> \</span><br><span class="line">     org.apache.catalina.startup.Bootstrap <span class="string">&quot;$@&quot;</span> start \</span><br></pre></td></tr></table></figure>
<p>后续不在赘述。重点在Server.properties中版本区别是否包含Netty的这个类,<br>本来我是想跟着dei一下bug的,实际是我没起来,版本又不兼容,中间穿插了需求,就不dei了skr~</p>
<h2 id="一方库、二方库、三方库说明"><a href="#一方库、二方库、三方库说明" class="headerlink" title="一方库、二方库、三方库说明"></a>一方库、二方库、三方库说明</h2><p>有些二方库为apache所需类库,当然定义也尽相同,以统一标准为准吧~就像嵌入式这个单词,<br>如果学习的时候根据服务的命名,猜测其作用,然后再去证实的话,可能我早就认识这个单词了</p>
<blockquote>
<p>一方库：本工程中的各模块的相互依赖<br>二方库：公司内部的依赖库,一般指公司内部的其他项目发布的jar包<br>三方库：公司之外的开源库, 比如apache、ibm、google等发布的依赖<br>为什么写这句话就是因为javax是指扩展我的java,因为原生的二方库是不允许被覆盖的。提到的</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Stream&lt;Wrapper&gt; <span class="title">getLoadOnStartupWrappers</span><span class="params">(Container[] children)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer, List&lt;Wrapper&gt;&gt; grouped = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">            Wrapper wrapper = (Wrapper) child;</span><br><span class="line">            <span class="keyword">int</span> order = wrapper.getLoadOnStartup();</span><br><span class="line">            <span class="keyword">if</span> (order &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                grouped.computeIfAbsent(order, ArrayList::<span class="keyword">new</span>);</span><br><span class="line">                grouped.get(order).add(wrapper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> grouped.values().stream().flatMap(List::stream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再比如这里面的grouped.computeIfAbsent(order, ArrayList::new);其中Absent译为缺席,入参是key=order,以及函数方法,在key!=null的情况下赋值为newAraayList并返回去。<br>and this flatMap VS map,其他人举的例子很明朗,我就不摘抄了,<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yucy/p/10260014.html">https://www.cnblogs.com/yucy/p/10260014.html</a></p>
<h2 id="JDBC中的servlet"><a href="#JDBC中的servlet" class="headerlink" title="JDBC中的servlet"></a>JDBC中的servlet</h2><blockquote>
<p>数据库三大范式：<br>1．第一范式(确保每列保持原子性)<br>2．第二范式(确保表中的每列都和主键相关)<br>3．第三范式(确保每列都和主键列直接相关,而不是间接相关)<br>1、DML:Data Manipulation Language  操作语句<br>2、DDL：data define Language、<br>3、存储过程执行后<br>4、查询中也是有事务的：select查询后结果集关闭后<br>事务并发可能的影响：<br>1、脏读（读取未提交数据）<br>A事务读取B事务尚未提交的数据,此时如果B事务发生错误并执行回滚操作,那么A事务读取到的数据就是脏数据。<br>就好像原本的数据比较干净、纯粹,此时由于B事务更改了它,这个数据变得不再纯粹。这个时候A事务立即读取了这个脏数据,<br>但事务B良心发现,又用回滚把数据恢复成原来干净、纯粹的样子,而事务A却什么都不知道,最终结果就是事务A读取了此次的脏数据,称为脏读。<br>2、不可重复读（前后多次读取,数据内容不一致）<br>事务A在执行读取操作,由整个事务A比较大,前后读取同一条数据需要经历很长的时间 。而在事务A第一次读取数据,<br>比如此时读取了小明的年龄为20岁,事务B执行更改操作,将小明的年龄更改为30岁,此时事务A第二次读取到小明的年龄时,<br>发现其年龄是30岁,和之前的数据不一样了,也就是数据不重复了,系统不可以读取到重复的数据,成为不可重复读<br>3、幻读（前后多次读取,数据总量不一致）<br>事务A在执行读取操作,需要两次统计数据的总量,前一次查询数据总量后,此时事务B执行了新增数据的操作并提交后,<br>这个时候事务A读取的数据总量和之前统计的不一样,就像产生了幻觉一样,平白无故的多了几条数据,成为幻读<br>幻读产生的根本原因是采用的行级锁,所以只针对脏读和重复读有用<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/drivermanager.png" alt="流程"><br>Drivermanager–&gt;getconnection—&gt;connection–&gt;createStatement–&gt;ResultSet executeQuery(String sql) throws SQLException;<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/connection.png" alt="流程"><br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/drivermanager.png" alt="流程"><br>重载connection方法可实现在各个数据库中切换,基本不需要太多的代码,JDBC中用到的设计模式？—-桥接模式<br>不知道为啥都在强调jdbc的设计模式,所以引用下《重学设计模式–小博哥》中的案例分析<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png" alt="流程"><br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%88%E4%BE%8B%E5%9C%BA%E6%99%AF.png" alt="场景"><br>代码实现登陆：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(PayController.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doPay</span><span class="params">(String uId, String tradeId, BigDecimal amount,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">int</span> channelType, <span class="keyword">int</span> modeType)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 微信⽀付</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == channelType) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;模拟微信渠道⽀付划账开始。uId：&#123;&#125; tradeId：&#123;&#125; amount：</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &quot;</span>, uId, tradeId, amount);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;密码⽀付,⻛控校验环境安全&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;⼈脸⽀付,⻛控校验脸部识别&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">3</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;指纹⽀付,⻛控校验指纹信息&quot;</span>);</span><br><span class="line"></span><br><span class="line">                上⾯的类提供了⼀个⽀付服务功能,通过提供的必要字段； ⽤户ID 、交易ID 、 ⾦额 、渠道 、模 式 ,来控制⽀付⽅式。</span><br><span class="line">                以上的 ifelse 应该是最差的⼀种写法,即使写 ifelse 也是可以优化的⽅式去写的。</span><br><span class="line">                <span class="number">3.</span> 测试验证</span><br><span class="line">                <span class="number">3.1</span> 编写测试类</span><br><span class="line">                以上分别测试了两种不同的⽀付类型和⽀付模式；微信⼈脸⽀付、⽀付宝指纹⽀付</span><br><span class="line">                <span class="number">3.2</span> 测试结果</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ⽀付宝⽀付</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == channelType) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;模拟⽀付宝渠道⽀付划账开始。uId：&#123;&#125; tradeId：&#123;&#125;</span></span><br><span class="line"><span class="string">                    amount： &#123;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &quot;</span>, uId, tradeId, amount);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;密码⽀付,⻛控校验环境安全&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;⼈脸⽀付,⻛控校验脸部识别&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">3</span> == modeType) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;指纹⽀付,⻛控校验指纹信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实面对这种情况一般我是看到大多数是应用策略+模板的,桥接真的很少听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pay</span> </span>&#123;</span><br><span class="line"> <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(Pay.class);</span><br><span class="line"> <span class="keyword">protected</span> IPayMode payMode;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Pay</span><span class="params">(IPayMode payMode)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">this</span>.payMode = payMode;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">transfer</span><span class="params">(String uId, String tradeId, BigDecimal</span></span></span><br><span class="line"><span class="params"><span class="function">amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个类中定义了⽀付⽅式的需要实现的划账接⼝： transfer ,以及桥接接⼝； IPayMode ,并<br>在构造函数中⽤户⽅⾃⾏选择⽀付⽅式。<br>如果没有接触过此类实现,可以᯿点关注 IPayMode payMode ,这部分是桥接的核⼼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPay</span> <span class="keyword">extends</span> <span class="title">Pay</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">WxPay</span><span class="params">(IPayMode payMode)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">super</span>(payMode);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">transfer</span><span class="params">(String uId, String tradeId, BigDecimal amount)</span> </span>&#123;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟微信渠道⽀付划账开始。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>,</span><br><span class="line">uId, tradeId, amount);</span><br><span class="line"> <span class="keyword">boolean</span> security = payMode.security(uId);</span><br><span class="line"> logger.info(<span class="string">&quot;模拟微信渠道⽀付⻛控校验。uId：&#123;&#125; tradeId：&#123;&#125; security：</span></span><br><span class="line"><span class="string">&#123;&#125;&quot;</span>, uId, tradeId, security);</span><br><span class="line"> <span class="keyword">if</span> (!security) &#123;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟微信渠道⽀付划账拦截。uId：&#123;&#125; tradeId：&#123;&#125; amount：</span></span><br><span class="line"><span class="string">&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;0001&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟微信渠道⽀付划账成功。uId：&#123;&#125; tradeId：&#123;&#125; amount：&#123;&#125;&quot;</span>,</span><br><span class="line">uId, tradeId, amount);</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;0000&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>支付宝支付</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class ZfbPay extends Pay &#123;</span><br><span class="line"> public ZfbPay(IPayMode payMode) &#123;</span><br><span class="line"> super(payMode);</span><br><span class="line"> &#125;</span><br><span class="line"> public String transfer(String uId, String tradeId, BigDecimal amount) &#123;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟⽀付宝渠道⽀付划账开始。uId：&#123;&#125; tradeId：&#123;&#125; amount：</span></span><br><span class="line"><span class="string">&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line"> boolean security = payMode.security(uId);</span><br><span class="line"> logger.info(<span class="string">&quot;模拟⽀付宝渠道⽀付⻛控校验。uId：&#123;&#125; tradeId：&#123;&#125; security：</span></span><br><span class="line"><span class="string">&#123;&#125;&quot;</span>, uId, tradeId, security);</span><br><span class="line"> <span class="keyword">if</span> (!security) &#123;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟⽀付宝渠道⽀付划账拦截。uId：&#123;&#125; tradeId：&#123;&#125;</span></span><br><span class="line"><span class="string">amount：&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;0001&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> logger.info(<span class="string">&quot;模拟⽀付宝渠道⽀付划账成功。uId：&#123;&#125; tradeId：&#123;&#125; amount：</span></span><br><span class="line"><span class="string">&#123;&#125;&quot;</span>, uId, tradeId, amount);</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;0000&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%9E%8B.png" alt="流程"><br>桥接模式接口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="keyword">interface</span> IPayMode &#123;</span><br><span class="line"> boolean security(String uId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刷脸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayFaceMode</span> <span class="keyword">implements</span> <span class="title">IPayMode</span></span>&#123;</span><br><span class="line"> <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(PayCypher.class);</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">security</span><span class="params">(String uId)</span> </span>&#123;</span><br><span class="line"> logger.info(<span class="string">&quot;⼈脸⽀付,⻛控校验脸部识别&quot;</span>);</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">其他同上</span><br></pre></td></tr></table></figure>
<p>测试类编写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_pay</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> System.out.println(<span class="string">&quot;\r\n模拟测试场景；微信⽀付、⼈脸⽅式。&quot;</span>);</span><br><span class="line"> Pay wxPay = <span class="keyword">new</span> WxPay(<span class="keyword">new</span> PayFaceMode());</span><br><span class="line"> wxPay.transfer(<span class="string">&quot;weixin_1092033111&quot;</span>, <span class="string">&quot;100000109893&quot;</span>, <span class="keyword">new</span></span><br><span class="line">BigDecimal(<span class="number">100</span>));</span><br><span class="line"> System.out.println(<span class="string">&quot;\r\n模拟测试场景；⽀付宝⽀付、指纹⽅式。&quot;</span>);</span><br><span class="line"> Pay zfbPay = <span class="keyword">new</span> ZfbPay(<span class="keyword">new</span> PayFingerprintMode());</span><br><span class="line"> zfbPay.transfer(<span class="string">&quot;jlu19dlxo111&quot;</span>,<span class="string">&quot;100000109894&quot;</span>,<span class="keyword">new</span> BigDecimal(<span class="number">100</span>));</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="ResultSet-executeQuery-String-sql-throws-SQLException"><a href="#ResultSet-executeQuery-String-sql-throws-SQLException" class="headerlink" title="ResultSet executeQuery(String sql) throws SQLException;"></a>ResultSet executeQuery(String sql) throws SQLException;</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;commons-dbcp&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-dbcp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">org.springframework.transaction.interceptor.TransactionInterceptor</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Class&lt;?&gt; targetClass = invocation.getThis() != <span class="keyword">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="keyword">null</span>;</span><br><span class="line">    Method var10001 = invocation.getMethod();</span><br><span class="line">    invocation.getClass();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.invokeWithinTransaction(var10001, targetClass, invocation::proceed);</span><br><span class="line">&#125;</span><br><span class="line">org.springframework.transaction.TransactionDefinition</span><br></pre></td></tr></table></figure>
<p>其实这里看不出来跟servlet的关联性有多么高,如果实在要说其中的关联性,<br>还不如将jdbc的整合过程与Mybatis进行比较,或者分析jdbc代码分析封装硬编码的过程,<br>就连其包下的大部分类名都不与之相关,当然你要说再Servlet与jdbc集成开发的时代,他也是有一定时代和代表性的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">(String url,</span></span></span><br><span class="line"><span class="params"><span class="function">    java.util.Properties info)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CallerSensitive是什么鬼？"><a href="#CallerSensitive是什么鬼？" class="headerlink" title="CallerSensitive是什么鬼？"></a>CallerSensitive是什么鬼？</h3><p>CallerSensitive老规矩,猜测下Caller=调用,Sensitive=敏感的,那么标识在方法上则是当调用方法时的一些控制。<br>其中特指Reflection.getCallerClass()能够追踪到调用者的第一人。项目中用是用不到。</p>
<h3 id="学习方法就是学习大佬的学习方法"><a href="#学习方法就是学习大佬的学习方法" class="headerlink" title="学习方法就是学习大佬的学习方法"></a>学习方法就是学习大佬的学习方法</h3><p>这里JDBC就先到此为止,我先不得不先记录下我在javacache中遇到的小问题思考。</p>
<h2 id="为什么有ConcurrentHashMap还要加入synchronized"><a href="#为什么有ConcurrentHashMap还要加入synchronized" class="headerlink" title="为什么有ConcurrentHashMap还要加入synchronized"></a>为什么有ConcurrentHashMap还要加入synchronized</h2><p>在org.springframework.cache.support.AbstractCacheManager中有一段关于初始化缓存静态配置的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialize the static configuration of caches.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Triggered on startup through &#123;<span class="doctag">@link</span> #afterPropertiesSet()&#125;;</span></span><br><span class="line"><span class="comment">     * can also be called to re-initialize at runtime.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 4.2.2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #loadCaches()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeCaches</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Collection&lt;? extends Cache&gt; caches = loadCaches();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">            <span class="keyword">this</span>.cacheNames = Collections.emptySet();</span><br><span class="line">            <span class="keyword">this</span>.cacheMap.clear();</span><br><span class="line">            Set&lt;String&gt; cacheNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(caches.size());</span><br><span class="line">            <span class="keyword">for</span> (Cache cache : caches) &#123;</span><br><span class="line">                String name = cache.getName();</span><br><span class="line">                <span class="keyword">this</span>.cacheMap.put(name, decorateCache(cache));</span><br><span class="line">                cacheNames.add(name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.cacheNames = Collections.unmodifiableSet(cacheNames);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><font color="red"> Triggered：触发 </font><br>原因：本身put和add的线程安全是由ConcurrentHashMap保证的,但是此时获取的值ConcurrentHashMap并不能保证其他线程对共享变量的值操作时还是原来的值。<br>怎么说呢,这么看来可能失去了map的本来特性,但其实还是不理解,是不理解这个原因准不准确。</p>
<p>谁提出谁解决:concurrentHashMap只能保证一次操作的原子性,一系列操作的时候就需要加锁了,不能保证第N+1个线程进来的时候获取到的状态是未clear的</p>
<p>Collections.emptySet()：如果你想 new 一个空的 List ,而这个 List 以后也不会再添加元素,那么就用 Collections.emptyList() 好了。<br>new ArrayList() 或者 new LinkedList() 在创建的时候有会有初始大小,多少会占用一内存。<br>每次使用都new 一个空的list集合,浪费就积少成多,浪费就严重啦,就不好啦。</p>
<p>还有一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        Cache cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cache;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Fully synchronize now for missing cache creation...</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">                cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">                <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    cache = getMissingCache(name);</span><br><span class="line">                    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        cache = decorateCache(cache);</span><br><span class="line">                        <span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">                        updateCacheNames(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> cache;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">其中的getMissingCache方法</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Cache <span class="title">getMissingCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">无论如何都要返回<span class="keyword">null</span>,那么他还要进行判空意义又何在？</span><br><span class="line"></span><br><span class="line">源码注释是这样写的</span><br><span class="line">Return a missing cache with the specified name, or <span class="keyword">null</span> <span class="keyword">if</span> such a cache does not exist or could not be created on demand.</span><br><span class="line">Caches may be lazily created at runtime <span class="keyword">if</span> the <span class="keyword">native</span> provider supports it. If a lookup by name does not yield any result, an AbstractCacheManager subclass gets a chance to register such a cache at runtime. The returned cache will be automatically added to <span class="keyword">this</span> cache manager.</span><br><span class="line">返回指定名称的缺失缓存,如果此类缓存不存在或无法按需创建,则返回<span class="keyword">null</span>。</span><br><span class="line">如果本机提供程序支持,可以在运行时延迟创建缓存,就是其扩展实际是在子类中来复写的,</span><br><span class="line">注意：在spring-data-redis的<span class="number">1.7</span><span class="number">.2</span>中是没有复写此方法的</span><br><span class="line">在官网中查询https:<span class="comment">//spring.io/projects/spring-data-redis#support</span></span><br><span class="line">接入了</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">2.1</span><span class="number">.9</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">低版本可是没有的呢,具体变化是在<span class="number">2.</span>X前后的区别</span><br><span class="line"><span class="function"><span class="keyword">protected</span> RedisCache <span class="title">getMissingCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allowInFlightCacheCreation ? createRedisCache(name, defaultCacheConfig) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="第二次见到identityHashMap"><a href="#第二次见到identityHashMap" class="headerlink" title="第二次见到identityHashMap"></a>第二次见到identityHashMap</h2><p>实际应用<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2ODA3NjA1MA==&amp;mid=2247484317&amp;idx=1&amp;sn=1a5d78d0e5d5e09b1d2ca969a5ae7d23&amp;chksm=ceb09ce0f9c715f6688bf4b38a933730f61df7b432b3ac452924b502fba735e048289c3e0d91&amp;token=950928768&amp;lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=Mzg2ODA3NjA1MA==&amp;mid=2247484317&amp;idx=1&amp;sn=1a5d78d0e5d5e09b1d2ca969a5ae7d23&amp;chksm=ceb09ce0f9c715f6688bf4b38a933730f61df7b432b3ac452924b502fba735e048289c3e0d91&amp;token=950928768&amp;lang=zh_CN#rd</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    var var1 = new Integer(1);</span><br><span class="line">    var var2 = new Integer(1);</span><br><span class="line">    System.out.println(var1.equals(var2));</span><br><span class="line"></span><br><span class="line">    System.out.println(var1.hashCode());</span><br><span class="line">    System.out.println(var2.hashCode());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    System.out.println(System.identityHashCode(var1));</span><br><span class="line">    System.out.println(System.identityHashCode(var2));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">控制台输出</span><br><span class="line">true</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1524960486</span><br><span class="line">117009527</span><br></pre></td></tr></table></figure>
<p>org.springframework.cache.Cache对于缓存是应用接口,<br>Hashmap是否是在并发写的情况下,如果是则不是线程安全的<br>Consistency(一致性)<br>getinclude<br>想要看到源文档时,搜索：JSR107规范即可<br>推荐文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f6a1eae">https://www.jianshu.com/p/f6a1eae</a></p>
<h3 id="接着来看缓存类CacheManager"><a href="#接着来看缓存类CacheManager" class="headerlink" title="接着来看缓存类CacheManager"></a>接着来看缓存类CacheManager</h3><p>从名字就能看出是管理缓存的类,CacheManager有两种,一种是Spring的,一种是javax的,就是上面所说的扩展类,但实现确实大体一致,<br>就接口实现入手,先从最简单的看起,从名字看就是SimpleCacheManager,提供最基本的set方法,load方法。<br>SimpleCacheManager在spring-context包下,5.1.4版本,rediscachemanager在spring-data-redis包下<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/fg15k701aa.png" alt="流程"></p>
<blockquote>
<p>CachingProvider：创建、配置、获取、管理和控制多个CacheManager<br>CacheManager：创建、配置、获取、管理和控制多个唯一命名的Cache。（一个CacheManager仅被一个CachingProvider所拥有）<br>Cache：一个类似Map的数据结构。（一个Cache仅被一个CacheManager所拥有）<br>Entry：一个存储在Cache中的key-value对<br>Expiry：每一个存储在Cache中的条目有一个定义的有效期,过期后不可访问、更新、删除。缓存有效期可以通过ExpiryPolicy设置<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1497762">https://cloud.tencent.com/developer/article/1497762</a><br>缓存么,除了快之外,还要满足有过期时间,但是除了在redis中并没有提供响应的方法,为什么呢？我觉得既然你启动或者加载就将bean放入cache管理了<br>就不可能伴随过期,应该会有响应的destroy方法在实例结束运行时清理,要不不可能实例还没运行完就进行清理吧。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Collection&lt;RedisCache&gt; <span class="title">loadCaches</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;RedisCache&gt; caches = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, RedisCacheConfiguration&gt; entry : initialCacheConfiguration.entrySet()) &#123;</span><br><span class="line">            caches.add(createRedisCache(entry.getKey(), entry.getValue()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> caches;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>读取缓存的配置时间,一级缓存60s,二级缓存30s<br>在spring-autoconfigure-metadata.properties中的org.springframework.data.redis.cache.RedisCacheConfiguration配置此参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration.AutoConfigureAfter=</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</span><br></pre></td></tr></table></figure>
<p>启动时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c.y.c.b.redis.config.RedisConfiguration  : [BSF][Redis]已启动,addressList:</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">45.674</span>  INFO <span class="number">2604</span> --- [           main] c.y.c.b.e.c.EurekaClientConfiguration    : [BSF][Eureka-Client]已启动!!! eureka.client.serviceUrl.defaultZone=http:<span class="comment">//10.:8080/eureka/</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">47.846</span>  WARN <span class="number">2604</span> --- [           main] c.n.c.sources.URLConfigurationSource     : No URLs will be polled as dynamic configuration sources.</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">47.847</span>  INFO <span class="number">2604</span> --- [           main] c.n.c.sources.URLConfigurationSource     : To enable URLs as dynamic configuration sources, define System property archaius.configurationSource.additionalUrls or make config.properties available on classpath.</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">47.943</span>  INFO <span class="number">2604</span> --- [           main] c.netflix.config.DynamicPropertyFactory  : DynamicPropertyFactory is initialized with configuration sources: com.netflix.config.ConcurrentCompositeConfiguration@4bf9f44b</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">54.662</span>  INFO <span class="number">2604</span> --- [           main] c.y.c.b.s.ShardingJdbcConfiguration      : [BSF][Sharding-jdbc]已启动!!!</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">57.232</span>  INFO <span class="number">2604</span> --- [           main] com.alibaba.druid.pool.DruidDataSource   : &#123;dataSource-<span class="number">1</span>&#125; inited</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">58.661</span>  INFO <span class="number">2604</span> --- [           main] com.alibaba.druid.pool.DruidDataSource   : &#123;dataSource-<span class="number">2</span>&#125; inited</span><br><span class="line"><span class="number">2022</span>-<span class="number">02</span>-<span class="number">18</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">02.531</span> ERROR <span class="number">2604</span> --- [           main] c.b.mybatisplus.MybatisConfiguration </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者在redisconfig中配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">simpleKeyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (o, method, objects) -&gt; &#123;</span><br><span class="line">            StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            stringBuilder.append(o.getClass().getSimpleName());</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">            stringBuilder.append(method.getName());</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Object obj : objects) &#123;</span><br><span class="line">                stringBuilder.append(obj.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(</span><br><span class="line">            RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory),</span><br><span class="line">            <span class="keyword">this</span>.getRedisCacheConfigurationWithTtl(<span class="number">600</span>), <span class="comment">// 默认策略,未配置的 key 会使用这个</span></span><br><span class="line">            <span class="keyword">this</span>.getRedisCacheConfigurationMap() <span class="comment">// 指定 key 策略</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, RedisCacheConfiguration&gt; <span class="title">getRedisCacheConfigurationMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, RedisCacheConfiguration&gt; redisCacheConfigurationMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        redisCacheConfigurationMap.put(<span class="string">&quot;UserInfoList&quot;</span>, <span class="keyword">this</span>.getRedisCacheConfigurationWithTtl(<span class="number">3000</span>));</span><br><span class="line">        redisCacheConfigurationMap.put(<span class="string">&quot;UserInfoListAnother&quot;</span>, <span class="keyword">this</span>.getRedisCacheConfigurationWithTtl(<span class="number">18000</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisCacheConfigurationMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RedisCacheConfiguration <span class="title">getRedisCacheConfigurationWithTtl</span><span class="params">(Integer seconds)</span> </span>&#123;</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        redisCacheConfiguration = redisCacheConfiguration.serializeValuesWith(</span><br><span class="line">            RedisSerializationContext</span><br><span class="line">                .SerializationPair</span><br><span class="line">                .fromSerializer(jackson2JsonRedisSerializer)</span><br><span class="line">        ).entryTtl(Duration.ofSeconds(seconds));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisCacheConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">过期时间</span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;UserInfoList&quot;, keyGenerator = &quot;simpleKeyGenerator&quot;)</span> <span class="comment">// 3000秒</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;UserInfoListAnother&quot;, keyGenerator = &quot;simpleKeyGenerator&quot;)</span> <span class="comment">// 18000秒</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;DefaultKeyTest&quot;, keyGenerator = &quot;simpleKeyGenerator&quot;)</span> <span class="comment">// 600秒,未指定的key,使用默认策略</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>在spring2.0前后差异<br>构造器差异<br>before</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RedisCacheManager cacheManager = <span class="keyword">new</span> RedisCacheManager(RedisTemplate redisTemplate);</span><br></pre></td></tr></table></figure>
<p>after</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RedisCacheManager cacheManager = <span class="keyword">new</span> RedisCacheManager(RedisCacheWriter redisCacheWriter,RedisCacheConfiguration redisCacheConfiguration);</span><br></pre></td></tr></table></figure>
<p>创建RedisCacheWriter分为有锁和无锁<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/rediscachewriter.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> RedisCacheWriter <span class="title">nonLockingRedisCacheWriter</span><span class="params">(RedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(connectionFactory, <span class="string">&quot;ConnectionFactory must not be null!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRedisCacheWriter(connectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    JedisConnectionFactory</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create new &#123;<span class="doctag">@link</span> RedisCacheWriter&#125; with locking behavior.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> connectionFactory must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> new instance of &#123;<span class="doctag">@link</span> DefaultRedisCacheWriter&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> RedisCacheWriter <span class="title">lockingRedisCacheWriter</span><span class="params">(RedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(connectionFactory, <span class="string">&quot;ConnectionFactory must not be null!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultRedisCacheWriter(connectionFactory, Duration.ofMillis(<span class="number">50</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>即使是同一个缓存CacheManager管理的缓存实例,配置有可能不一样。<br>指定redis数据序列化<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/connectionfactory.png" alt="流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(keySerializer()))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(valueSerializer()))</span><br></pre></td></tr></table></figure>
<p>JAVA序列化方式<br>序列化方式一实现：Serializable接口<br>序列化方式二：Externalizable显式序列化<br>序列化方式三：实现Serializable接口+添加writeObject()和readObject()方法。(显+隐序列化)<br>对了,想要使用cache记得开启缓存注解,@EnableCaching<br>转过头来看下CacheOperation,这里面是缓存相关注解的父类,在SpringCacheAnnotationParser中管理了子类相关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(Cacheable.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(CacheEvict.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(CachePut.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(Caching.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>解析注解的时候他们的入参,实现一模一样,只有返回值不一样,但是一模一样的代码写了三遍,为什么不判断类型动态返回呢~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Collection&lt;CacheOperation&gt; <span class="title">parseCacheAnnotations</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            DefaultCacheConfig cachingConfig, AnnotatedElement ae, <span class="keyword">boolean</span> localOnly)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Collection&lt;? extends Annotation&gt; anns = (localOnly ?</span><br><span class="line">                AnnotatedElementUtils.getAllMergedAnnotations(ae, CACHE_OPERATION_ANNOTATIONS) :</span><br><span class="line">                AnnotatedElementUtils.findAllMergedAnnotations(ae, CACHE_OPERATION_ANNOTATIONS));</span><br><span class="line">        <span class="keyword">if</span> (anns.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Collection&lt;CacheOperation&gt; ops = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        anns.stream().filter(ann -&gt; ann <span class="keyword">instanceof</span> Cacheable).forEach(</span><br><span class="line">                ann -&gt; ops.add(parseCacheableAnnotation(ae, cachingConfig, (Cacheable) ann)));</span><br><span class="line">        anns.stream().filter(ann -&gt; ann <span class="keyword">instanceof</span> CacheEvict).forEach(</span><br><span class="line">                ann -&gt; ops.add(parseEvictAnnotation(ae, cachingConfig, (CacheEvict) ann)));</span><br><span class="line">        anns.stream().filter(ann -&gt; ann <span class="keyword">instanceof</span> CachePut).forEach(</span><br><span class="line">                ann -&gt; ops.add(parsePutAnnotation(ae, cachingConfig, (CachePut) ann)));</span><br><span class="line">        anns.stream().filter(ann -&gt; ann <span class="keyword">instanceof</span> Caching).forEach(</span><br><span class="line">                ann -&gt; parseCachingAnnotation(ae, cachingConfig, (Caching) ann, ops));</span><br><span class="line">        <span class="keyword">return</span> ops;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CacheableOperation <span class="title">parseCacheableAnnotation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            AnnotatedElement ae, DefaultCacheConfig defaultConfig, Cacheable cacheable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CacheableOperation.Builder builder = <span class="keyword">new</span> CacheableOperation.Builder();</span><br><span class="line"></span><br><span class="line">        builder.setName(ae.toString());</span><br><span class="line">        builder.setCacheNames(cacheable.cacheNames());</span><br><span class="line">        builder.setCondition(cacheable.condition());</span><br><span class="line">        builder.setUnless(cacheable.unless());</span><br><span class="line">        builder.setKey(cacheable.key());</span><br><span class="line">        builder.setKeyGenerator(cacheable.keyGenerator());</span><br><span class="line">        builder.setCacheManager(cacheable.cacheManager());</span><br><span class="line">        builder.setCacheResolver(cacheable.cacheResolver());</span><br><span class="line">        builder.setSync(cacheable.sync());</span><br><span class="line"></span><br><span class="line">        defaultConfig.applyDefault(builder);</span><br><span class="line">        CacheableOperation op = builder.build();</span><br><span class="line">        validateCacheOperation(ae, op);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CacheEvictOperation <span class="title">parseEvictAnnotation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            AnnotatedElement ae, DefaultCacheConfig defaultConfig, CacheEvict cacheEvict)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CacheEvictOperation.Builder builder = <span class="keyword">new</span> CacheEvictOperation.Builder();</span><br><span class="line"></span><br><span class="line">        builder.setName(ae.toString());</span><br><span class="line">        builder.setCacheNames(cacheEvict.cacheNames());</span><br><span class="line">        builder.setCondition(cacheEvict.condition());</span><br><span class="line">        builder.setKey(cacheEvict.key());</span><br><span class="line">        builder.setKeyGenerator(cacheEvict.keyGenerator());</span><br><span class="line">        builder.setCacheManager(cacheEvict.cacheManager());</span><br><span class="line">        builder.setCacheResolver(cacheEvict.cacheResolver());</span><br><span class="line">        builder.setCacheWide(cacheEvict.allEntries());</span><br><span class="line">        builder.setBeforeInvocation(cacheEvict.beforeInvocation());</span><br><span class="line"></span><br><span class="line">        defaultConfig.applyDefault(builder);</span><br><span class="line">        CacheEvictOperation op = builder.build();</span><br><span class="line">        validateCacheOperation(ae, op);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CacheOperation <span class="title">parsePutAnnotation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            AnnotatedElement ae, DefaultCacheConfig defaultConfig, CachePut cachePut)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        CachePutOperation.Builder builder = <span class="keyword">new</span> CachePutOperation.Builder();</span><br><span class="line"></span><br><span class="line">        builder.setName(ae.toString());</span><br><span class="line">        builder.setCacheNames(cachePut.cacheNames());</span><br><span class="line">        builder.setCondition(cachePut.condition());</span><br><span class="line">        builder.setUnless(cachePut.unless());</span><br><span class="line">        builder.setKey(cachePut.key());</span><br><span class="line">        builder.setKeyGenerator(cachePut.keyGenerator());</span><br><span class="line">        builder.setCacheManager(cachePut.cacheManager());</span><br><span class="line">        builder.setCacheResolver(cachePut.cacheResolver());</span><br><span class="line"></span><br><span class="line">        defaultConfig.applyDefault(builder);</span><br><span class="line">        CachePutOperation op = builder.build();</span><br><span class="line">        validateCacheOperation(ae, op);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseCachingAnnotation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            AnnotatedElement ae, DefaultCacheConfig defaultConfig, Caching caching, Collection&lt;CacheOperation&gt; ops)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Cacheable[] cacheables = caching.cacheable();</span><br><span class="line">        <span class="keyword">for</span> (Cacheable cacheable : cacheables) &#123;</span><br><span class="line">            ops.add(parseCacheableAnnotation(ae, defaultConfig, cacheable));</span><br><span class="line">        &#125;</span><br><span class="line">        CacheEvict[] cacheEvicts = caching.evict();</span><br><span class="line">        <span class="keyword">for</span> (CacheEvict cacheEvict : cacheEvicts) &#123;</span><br><span class="line">            ops.add(parseEvictAnnotation(ae, defaultConfig, cacheEvict));</span><br><span class="line">        &#125;</span><br><span class="line">        CachePut[] cachePuts = caching.put();</span><br><span class="line">        <span class="keyword">for</span> (CachePut cachePut : cachePuts) &#123;</span><br><span class="line">            ops.add(parsePutAnnotation(ae, defaultConfig, cachePut));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>JSR(JCP  Java Community Process)文档查询地址,例如JSR107规范,servlet规范等等,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/web.html</span><br></pre></td></tr></table></figure>
<p>以及各类中文版在线开发文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.docs4dev.com/docs</span></span><br></pre></td></tr></table></figure>
<p>对了本次的主题虽然是Servlet,但不全是Servlet,都是用servlet带出来的,比如现在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    TimeUnit unit,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="keyword">boolean</span> waitForTasksToCompleteOnShutdown,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="keyword">long</span> awaitTerminationMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@NonNull</span> BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@NonNull</span> String threadPoolId,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@NonNull</span> ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@NonNull</span> RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, waitForTasksToCompleteOnShutdown, awaitTerminationMillis, workQueue, threadPoolId, threadFactory, handler);</span><br><span class="line">       <span class="keyword">this</span>.threadPoolId = threadPoolId;</span><br><span class="line"></span><br><span class="line">       RejectedExecutionHandler rejectedProxy = (RejectedExecutionHandler) Proxy</span><br><span class="line">               .newProxyInstance(</span><br><span class="line">                       handler.getClass().getClassLoader(),</span><br><span class="line">                       <span class="keyword">new</span> Class[]&#123;RejectedExecutionHandler.class&#125;,</span><br><span class="line">                       <span class="keyword">new</span> RejectedProxyInvocationHandler(handler, rejectCount));</span><br><span class="line">       setRejectedExecutionHandler(rejectedProxy);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>mybatis动态代理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里使用JDK动态代理,通过Proxy.newProxyInstance生成动态代理类</span></span><br><span class="line">    <span class="comment">// newProxyInstance的参数：类加载器、接口类、InvocationHandler接口实现类</span></span><br><span class="line">    <span class="comment">// 动态代理可以将所有接口的调用重定向到调用处理器InvocationHandler,调用它的invoke方法</span></span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>问题： 一个接口方法,返回值相同,方法相同,参数为Person,现在有子类PersonMan和PersonWoman,如何对接口进行适配？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  Integer age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonMan</span> <span class="keyword">extends</span>  <span class="title">Person</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String character;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonWoman</span>  <span class="keyword">extends</span> <span class="title">Person</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String constellation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在泛型类型中支持class等,以及省去参数转换的上界通配符&lt;? extends E&gt;：上界通配符,表明参数化类型可能是所指定的类型,或者此类型的子类；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ElementType</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Class, interface (including annotation type), or enum declaration */</span></span><br><span class="line">    TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Field declaration (includes enum constants) */</span></span><br><span class="line">    FIELD,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Method declaration */</span></span><br><span class="line">    METHOD,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Formal parameter declaration */</span></span><br><span class="line">    PARAMETER,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Constructor declaration */</span></span><br><span class="line">    CONSTRUCTOR,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Local variable declaration */</span></span><br><span class="line">    LOCAL_VARIABLE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Annotation type declaration */</span></span><br><span class="line">    ANNOTATION_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Package declaration */</span></span><br><span class="line">    PACKAGE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Type parameter declaration</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TYPE_PARAMETER,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Use of a type</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TYPE_USE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface PersonService &#123;</span><br><span class="line"></span><br><span class="line">    public void  queryPerson(List&lt;? extends Person&gt; list);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class PersonServiceImpl implements PersonService&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void queryPerson(List&lt;? extends Person&gt; list) &#123;</span><br><span class="line">        System.out.println(JSONObject.toJSONString(list));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Person&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//List&lt;PersonMan&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//List&lt;PersonWoman&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">personService.queryPerson(list);</span><br></pre></td></tr></table></figure>
<p>那么如果参数类型为注解呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryPerson</span><span class="params">(List&lt;? extends Person&gt; list,Class&lt;? extends Annotation&gt; t)</span> </span>&#123;</span><br><span class="line">        System.out.println(JSONObject.toJSONString(list));</span><br><span class="line">       </span><br><span class="line">        System.out.println(cast.annotationType());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么为什么上面的parsePutAnnotation不用呢？<br>NONONO,其实是用了的,只不过方法不同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static final Set&lt;Class&lt;? extends Annotation&gt;&gt; CACHE_OPERATION_ANNOTATIONS = new LinkedHashSet&lt;&gt;(8);</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(Cacheable.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(CacheEvict.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(CachePut.class);</span><br><span class="line">        CACHE_OPERATION_ANNOTATIONS.add(Caching.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其实我就是看他的写的emoj,而且在caching这个注解里他包含了4种注解,然后统一进行管理的。</p>
<p>插播：Dbeaver中普通操作都会,安利一个类似idea的快捷键功能,Template—&gt;SQL编辑器中可设置常用SQL,快捷键加Tab唤出.</p>
<h3 id="国际化包含文本的国际化和时区的国际化"><a href="#国际化包含文本的国际化和时区的国际化" class="headerlink" title="国际化包含文本的国际化和时区的国际化"></a>国际化包含文本的国际化和时区的国际化</h3><h3 id="Repository-VS-NoRepositoryBean"><a href="#Repository-VS-NoRepositoryBean" class="headerlink" title="@Repository VS  @NoRepositoryBean"></a>@Repository VS  @NoRepositoryBean</h3><p>回到cache相关中,在开启缓存时提示错误需要加入@Enablecahing注解,而在验证缓存注解时,在接口加了NoRepositoryBean,那么NoRepositoryBean又是什么？跟@Repository有何不同？<br>NoRepositoryBean：见名知意就是不需要创建的bean,在Springboot jpa中标识,雷同与不需要序列化的字段标识transient；<br>NoRepositoryBean用做标记当前接口或者类（抽象）不应该作为RepositoryBean被注册到Spring上下文,Springdata提供了自动代理的机制</p>
<h2 id="JMS-java-message-service-JSR-914"><a href="#JMS-java-message-service-JSR-914" class="headerlink" title="JMS(java  message service)JSR-914"></a>JMS(java  message service)JSR-914</h2><p>1.JMS：用于应用程序之间,或在分布式系统中发送消息。而一些生产者,消费者,消息等不是消息队列的特指,而是JMS的所有特性。<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/jms.jpg" alt="Liucheng"><br>2.AMQP：(Advanced Message Queuing Protocol)<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/AMQP.png" alt="Liucheng"><br>消息队列协议,中文规范,消息代理(message brokers) 从发布者（publisher）亦称作生产者（producers）接受消息,根据<br>不同的路由规则（Routing Rule）把接受到的消息发送给处理消息的消费者（consumers）；</p>
<h1 id="3-kafka-零拷贝？-哎嗨-重点来了"><a href="#3-kafka-零拷贝？-哎嗨-重点来了" class="headerlink" title="3.kafka? 零拷贝？ 哎嗨,重点来了"></a>3.kafka? 零拷贝？ 哎嗨,重点来了</h1><p>官网：<a target="_blank" rel="noopener" href="https://kafka.apache.org/">https://kafka.apache.org/</a><br>Kafka是一个分布式的基于发布/订阅模式的消息队列（Message Queue）,主要应用于大数据实时处理领域。<br>其实大多数的消息队列的实时性只能保持在秒级,而在银行是能够在纳秒之间的,kafka2.8.x之前是基于zookeeper的,<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/kafka.png" alt="kafka"><br>架构图<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/kafka2.png" alt="kafka"></p>
<p>默认分区内存大小32M,每个批次大小是16K<br>1.批次数据满了才会发送,16K<br>2.linger.ms批次数据未满时,延迟发送时间<br>Sender数据拉取<br>同步vs异步发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>配置</span><br><span class="line"><span class="number">2.</span>连接集群</span><br><span class="line"><span class="number">3.</span>指定序列化类型</span><br><span class="line"><span class="number">4.</span>创建生产者</span><br><span class="line"><span class="number">5.</span>发送数据</span><br><span class="line"><span class="number">6.</span>关闭资源</span><br></pre></td></tr></table></figure>
<p>分区自定义,合理使用资源,负载均衡<br>可配置类都要放到统一类管理<br>1.指定分区的情况<br>2.没有指定分区,带key,key的hash值与topic的分区值取模<br>3.没有指定分区,不带key,粘性分区,随机选择一个分区,尽可能一直使用该分区<br>自定义分区器：实现分区器接口<br>一般会说那个表名作为key<br>自定义分区器：<br>恰好达到批次大小就进行发送<br>导致数据延迟：<br>生产环境配置5-100ms之间<br>压缩类型snappy<br>提供生产者吞吐量<br>应答ack  0   1  -1<br>动态ISR replica.lag.time.max.ms默认30s,超出则踢出<br>数据完全可靠条件：<br><font color="red"> ACK级别设置为1 +分区副本大于等于2 +ISR应答最小副本数量大于等于2  </font><br>要求可靠性<br>要求速度<br>默认值为int最大值<br>ack和重试数据<br>幂等性和事务:保证单分区单回话内不会重复<br>开启事务,必须开启幂等性<br>指定事务id<br>数据有序<br>单分区有序：<br>多分区有序：<br>数据乱序<br>kafka1.x前后差别：<br>是否开启幂等性区别：<br>其中一个出现异常则先缓存,后落盘<br>zookeeper中存放的信息<br>工具：prettyzoo</p>
<p>1、brokerid<br>2、主题<br>3.消费者信息</p>
<p><font color="green">AR:是kafka中你那个所有分区副本的总称</font><br><font color="green">ISR:leader和follower之间正常通讯的节点</font><br>除了基础知识点之外我最想看的就是kafka的零拷贝跟netty的关系。</p>
<blockquote>
<p>DMA<br>在介绍零拷贝之前,我们先来看一个技术名词DMA（Direct Memory Access<br>直接内存访问）。它是现代电脑的重要特征之一,允许不同速度的硬件之间直接交互,而不需要占用CPU的中断负载。DMA传输将一个地址空间复制到另一个地址空间,当CPU<br>初始化这个传输之后,实际的数据传输是有DMA设备之间完成,这样可以大大的减少CPU的消耗。我们常见的硬件设备都支持DMA</p>
</blockquote>
<p>零拷贝有两种方式：mmap/sendfile,而直接内存的方式跟Netty也是如出一辙。<br>关于压缩类型snappy,他是Java提供的实现,在maven以来中可在kafka中看到<br><img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/snappy.png" alt="kafka"></p>
<h3 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.apache.kafka.clients.producer.ProducerRecord</span><br><span class="line">    可指定主题</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line">    分区</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer partition;</span><br><span class="line">    头信息</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Headers headers;</span><br><span class="line">    key</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> K key;</span><br><span class="line">    value</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> V value;</span><br><span class="line">    linger.ms</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long timestamp;</span><br></pre></td></tr></table></figure>
<p>构造器有几种,对于发送消息就有几种类型,consumerRecord同理,key和value需要指定序列化类。<br>所有的配置项存放在ProducerConfig中,本来想看几个代表性参数就可以了,但是后续的调优参数有很多配置是用的到的,还是要仔细看看。<br>比如每个batchsize批次内存大小默认是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.define(BATCH_SIZE_CONFIG, Type.INT, 16384, atLeast(0), Importance.MEDIUM, BATCH_SIZE_DOC)</span><br></pre></td></tr></table></figure>
<p>16384/1024=16k<br>比如linger.ms默认为0ms</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.define(LINGER_MS_CONFIG, Type.LONG, 0, atLeast(0), Importance.MEDIUM, LINGER_MS_DOC)</span><br></pre></td></tr></table></figure>
<p>key指定的序列化类为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Serializer class for key that implements the &lt;code&gt;org.apache.kafka.common.serialization.Serializer&lt;/code&gt; interface.</span><br><span class="line">如果在配置文件中指定则需要全限定类名</span><br></pre></td></tr></table></figure>
<h3 id="zookeeper中存放的信息"><a href="#zookeeper中存放的信息" class="headerlink" title="zookeeper中存放的信息"></a>zookeeper中存放的信息</h3><p>broker启动后在zookeeper中注册<br>controller将节点信息记录到zookeeper中,推荐使用工具链接prettyzoo,存放brokerid,topic,消费者信息等。</p>
<h3 id="Linux新增知识点"><a href="#Linux新增知识点" class="headerlink" title="Linux新增知识点"></a>Linux新增知识点</h3><p>kafka 搭配 xcall jps ,查看集群下机器节点</p>
<h3 id="kafka服务器挂了怎么办？"><a href="#kafka服务器挂了怎么办？" class="headerlink" title="kafka服务器挂了怎么办？"></a>kafka服务器挂了怎么办？</h3><p>1.先尝试重启,重启成功直接解决<br>2.增加内存,CPU,宽带<br>3.如果副本数大于等于2,可以按照服役新节点方法执行,并配置负载均衡</p>
<h3 id="Broker中的重要参数"><a href="#Broker中的重要参数" class="headerlink" title="Broker中的重要参数"></a>Broker中的重要参数</h3><table>
<thead>
<tr>
<th align="left">参数名称</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">replica.lag.time.max.ms</td>
<td align="left">ISR 中,如果 Follower 长时间未向 Leader 发送通信请求或同步数据,则该 Follower 将被踢出 ISR。该时间阈值,<font color="red">默认30s</font> 。</td>
</tr>
<tr>
<td align="left">auto.leader.rebalance.enable</td>
<td align="left"><font color="red">默认是 true</font>。 自动 Leader Partition 平衡。</td>
</tr>
<tr>
<td align="left">leader.imbalance.per.broker.percentage</td>
<td align="left"><font color="red">默认是 10%</font>。每个 broker 允许的不平衡的 leader的比率。如果每个 broker 超过了这个值,控制器会触发 leader 的平衡。</td>
</tr>
<tr>
<td align="left">leader.imbalance.check.interval.seconds</td>
<td align="left"><font color="red">认值 300 秒 </font>。检查 leader 负载是否平衡的间隔时间。</td>
</tr>
<tr>
<td align="left">log.segment.bytes</td>
<td align="left">Kafka 中 log 日志是分成一块块存储的,此配置是指 log 日志划分 成块的大小,<font color="red">默认值 1G</font>。</td>
</tr>
<tr>
<td align="left">log.index.interval.bytes</td>
<td align="left"><font color="red">默认 4kb</font>,kafka 里面每当写入了 4kb 大小的日志（.log）,然后就往 index 文件里面记录一个索引</td>
</tr>
<tr>
<td align="left">log.retention.hours</td>
<td align="left">Kafka 中数据保存的时间,<font color="red">默认7天</font>。</td>
</tr>
<tr>
<td align="left">log.retention.minutes</td>
<td align="left">Kafka 中数据保存的时间,分钟级别,<font color="red">默认关闭</font>。</td>
</tr>
</tbody></table>
<h3 id="文件清理策略"><a href="#文件清理策略" class="headerlink" title="文件清理策略"></a>文件清理策略</h3><p>Kafka 中默认的日志保存时间为<font color="red">7天</font>。<br>日志删除策略</p>
</div>

			<link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css">
			<script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
				try {
					var plugin = new ReadmorePlugin();
					plugin.init({
						"type": "hexo",
						"id": "readmore-container",
						"name": "赵KK日常技术记录",
						"blogId": "62435-1742912502174-081",
						"qrcode": "https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/999.png",
						"keyword": "验证码",
						"random": "1",
						"height": "auto",
						"expires": "7",
						"lockToc": "yes",
						"interval": "60",
						"baseUrl": ""
					});
				} catch(e) {
					console.warn("readmore plugin occurred error: " + e.name + " | " + e.message);
				}
			}
			</script>
		
      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://zkkget.github.io/posts/20220127clho7byh60014vwuj5v684524.html" title="【置顶】Springboot之---强大的Servlet" target="_blank" rel="external">https://zkkget.github.io/posts/20220127clho7byh60014vwuj5v684524.html</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://kkget.github.io/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://kkget.github.io/" target="_blank"><span class="text-dark">赵kk</span><small class="ml-1x">java Developer &amp; pm</small></a></h3>
        <div>纠结体本体,同步记录日常笔记，Write the code, Change the world！</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/posts/20220207clho7byhv002pvwuj621nh84m.html" title="还在手动写单元测试？"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/posts/20220126clho7byhn0024vwujgyvb98bz.html" title="如何删除valine评论"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220826100219.jpg" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220112102818.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



            {% if post.top %}
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          {% endif %}
</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://kkget.github.io/" target="_blank" title="主站博客" data-toggle=tooltip data-placement=top><i class="icon icon-主站博客"></i></a></li>
        
        <li><a href="https://zkk-1300025204.cos.ap-nanjing.myqcloud.com/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.png" target="_blank" title="公众号" data-toggle=tooltip data-placement=top><i class="icon icon-公众号"></i></a></li>
        
        <li><a href="https://cloud.tencent.com/developer/inventory/14725" target="_blank" title="云+社区" data-toggle=tooltip data-placement=top><i class="icon icon-云+社区"></i></a></li>
        
        <li><a href="/1462018576" target="_blank" title="QQ" data-toggle=tooltip data-placement=top><i class="icon icon-QQ"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>

  <div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span >本站总访问量: <span id="busuanzi_value_site_pv"></span>次</span>
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1840459406&auto=1&height=66"></iframe>
  </div>


</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '5qofQKP6PLlRGj9AKdN2wFy8-gzGzoHsz',
    appKey: 'MUjdIW5XaUutRWAdIFu4IdxP',
    placeholder: '来都来了，说点啥吧~',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     



  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/01/assets/haru01.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
<!--<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script> -->
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
<!--崩溃欺骗-->
<script type="text/javascript" src="/js/src/crash_cheat.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</html>